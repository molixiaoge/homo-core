# å­˜å‚¨æ¨¡å—ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

homo-core å­˜å‚¨æ¨¡å—æä¾›äº†ç»Ÿä¸€çš„æ•°æ®å­˜å‚¨èƒ½åŠ›ï¼Œæ”¯æŒå¤šçº§ç¼“å­˜ã€è‡ªåŠ¨è½åœ°ã€è¯»å†™åˆ†ç¦»ç­‰ç‰¹æ€§ã€‚åŸºäº Redis + MySQL çš„å­˜å‚¨æ¶æ„ï¼Œä¸ºæ¸¸æˆæœåŠ¡å™¨æä¾›äº†é«˜æ€§èƒ½ã€é«˜å¯é çš„æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ **å¤šçº§ç¼“å­˜**: Redis ä¸€çº§ç¼“å­˜ + æœ¬åœ°äºŒçº§ç¼“å­˜
- ğŸ”„ **è‡ªåŠ¨è½åœ°**: æ•°æ®è‡ªåŠ¨ä» Redis è½åœ°åˆ° MySQL
- âš–ï¸ **è¯»å†™åˆ†ç¦»**: æ”¯æŒä¸»ä»æ•°æ®åº“è¯»å†™åˆ†ç¦»
- ğŸ›¡ï¸ **æ•°æ®ä¸€è‡´æ€§**: ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå¯é æ€§
- âš¡ **é«˜æ€§èƒ½**: åŸºäºå“åº”å¼ç¼–ç¨‹ï¼Œæ”¯æŒé«˜å¹¶å‘æ“ä½œ
- ğŸ”§ **çµæ´»é…ç½®**: æ”¯æŒå¤šç§å­˜å‚¨ç­–ç•¥å’Œé…ç½®

## ç¯å¢ƒè¦æ±‚

- **JDK**: 8 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Redis**: 3.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **MySQL**: 5.7 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Maven**: 3.6.0 æˆ–æ›´é«˜ç‰ˆæœ¬

## å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ ä¾èµ–

```xml
<dependencies>
    <!-- å­˜å‚¨åŸºç¡€æ¨¡å— -->
    <dependency>
        <groupId>com.homo</groupId>
        <artifactId>homo-core-storage</artifactId>
    </dependency>
    
    <!-- Redis å­˜å‚¨é©±åŠ¨ -->
    <dependency>
        <groupId>com.homo</groupId>
        <artifactId>homo-core-storage-redis-mysql</artifactId>
    </dependency>
    
    <!-- Redis åŸºç¡€æ¨¡å— -->
    <dependency>
        <groupId>com.homo</groupId>
        <artifactId>homo-core-redis-base</artifactId>
    </dependency>
    
    <!-- MySQL åŸºç¡€æ¨¡å— -->
    <dependency>
        <groupId>com.homo</groupId>
        <artifactId>homo-core-mysql-base</artifactId>
    </dependency>
</dependencies>
```

### 2. é…ç½®å­˜å‚¨

åœ¨ `application.properties` ä¸­é…ç½®ï¼š

```properties
# Apollo é…ç½®
apollo.bootstrap.enabled=true
apollo.bootstrap.namespaces=application,homo_redis_config,redis_connect_info,homo_root_info

# Redis é…ç½®
homo.redis.url=redis://localhost:6379
homo.redis.port=6379
homo.redis.auth=
homo.redis.dataBase=0
homo.redis.timeOutMs=300000
homo.redis.maxTotal=100
homo.redis.maxIdle=10
homo.redis.minIdle=10

# MySQL é…ç½®
homo.datasource.url=jdbc:mysql://localhost:3306/game_db
homo.datasource.username=root
homo.datasource.password=password
homo.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# å­˜å‚¨é…ç½®
homo.storage.redis.key.template=slug-data:{%s:%s:%s:%s}
homo.storage.mysql.table.prefix=homo_storage
```

### 3. ä½¿ç”¨ ByteStorage

```java
@Service
public class UserDataService extends BaseService {
    
    @Autowired
    private ByteStorage byteStorage;
    
    // ä¿å­˜ç”¨æˆ·æ•°æ®
    public Homo<Boolean> saveUserData(String userId, Map<String, byte[]> userData) {
        log.info("ä¿å­˜ç”¨æˆ·æ•°æ®: userId={}", userId);
        
        return byteStorage.update("UserData", userId, userData)
            .nextDo(result -> {
                boolean success = result.getKey();
                if (success) {
                    log.info("ç”¨æˆ·æ•°æ®ä¿å­˜æˆåŠŸ: userId={}", userId);
                } else {
                    log.warn("ç”¨æˆ·æ•°æ®ä¿å­˜å¤±è´¥: userId={}", userId);
                }
                return Homo.result(success);
            })
            .onErrorContinue(throwable -> {
                log.error("ä¿å­˜ç”¨æˆ·æ•°æ®å¼‚å¸¸: userId={}", userId, throwable);
                return Homo.result(false);
            });
    }
    
    // è·å–ç”¨æˆ·æ•°æ®
    public Homo<Map<String, byte[]>> getUserData(String userId, List<String> fields) {
        log.info("è·å–ç”¨æˆ·æ•°æ®: userId={}, fields={}", userId, fields);
        
        return byteStorage.get("UserData", userId, fields)
            .nextDo(userData -> {
                if (userData != null && !userData.isEmpty()) {
                    log.info("è·å–ç”¨æˆ·æ•°æ®æˆåŠŸ: userId={}, dataSize={}", userId, userData.size());
                } else {
                    log.warn("ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨: userId={}", userId);
                }
                return Homo.result(userData);
            })
            .onErrorContinue(throwable -> {
                log.error("è·å–ç”¨æˆ·æ•°æ®å¼‚å¸¸: userId={}", userId, throwable);
                return Homo.result(new HashMap<>());
            });
    }
    
    // åˆ é™¤ç”¨æˆ·æ•°æ®
    public Homo<Boolean> deleteUserData(String userId, List<String> fields) {
        log.info("åˆ é™¤ç”¨æˆ·æ•°æ®: userId={}, fields={}", userId, fields);
        
        return byteStorage.removeKeys("UserData", userId, fields)
            .nextDo(result -> {
                log.info("ç”¨æˆ·æ•°æ®åˆ é™¤ç»“æœ: userId={}, success={}", userId, result);
                return Homo.result(result);
            });
    }
}
```

### 4. ä½¿ç”¨ ObjStorage

```java
@Service
public class UserObjectService extends BaseService {
    
    @Autowired
    private ObjStorage objStorage;
    
    // ä¿å­˜ç”¨æˆ·å¯¹è±¡
    public Homo<Boolean> saveUser(User user) {
        log.info("ä¿å­˜ç”¨æˆ·å¯¹è±¡: userId={}", user.getUserId());
        
        return objStorage.save(user)
            .nextDo(result -> {
                if (result) {
                    log.info("ç”¨æˆ·å¯¹è±¡ä¿å­˜æˆåŠŸ: userId={}", user.getUserId());
                } else {
                    log.warn("ç”¨æˆ·å¯¹è±¡ä¿å­˜å¤±è´¥: userId={}", user.getUserId());
                }
                return Homo.result(result);
            });
    }
    
    // åŠ è½½ç”¨æˆ·å¯¹è±¡
    public Homo<User> loadUser(String userId) {
        log.info("åŠ è½½ç”¨æˆ·å¯¹è±¡: userId={}", userId);
        
        return objStorage.load("UserData", userId, User.class)
            .nextDo(user -> {
                if (user != null) {
                    log.info("ç”¨æˆ·å¯¹è±¡åŠ è½½æˆåŠŸ: userId={}", userId);
                } else {
                    log.warn("ç”¨æˆ·å¯¹è±¡ä¸å­˜åœ¨: userId={}", userId);
                }
                return Homo.result(user);
            })
            .onErrorContinue(throwable -> {
                log.error("åŠ è½½ç”¨æˆ·å¯¹è±¡å¼‚å¸¸: userId={}", userId, throwable);
                return Homo.result(null);
            });
    }
}
```

## å­˜å‚¨æ¶æ„

### 1. å¤šçº§ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨å±‚        â”‚    â”‚   åº”ç”¨å±‚        â”‚    â”‚   åº”ç”¨å±‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   äºŒçº§ç¼“å­˜      â”‚    â”‚   äºŒçº§ç¼“å­˜      â”‚    â”‚   äºŒçº§ç¼“å­˜      â”‚
â”‚   (æœ¬åœ°å†…å­˜)    â”‚    â”‚   (æœ¬åœ°å†…å­˜)    â”‚    â”‚   (æœ¬åœ°å†…å­˜)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ä¸€çº§ç¼“å­˜      â”‚
                    â”‚   (Redis)       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   æŒä¹…åŒ–å­˜å‚¨    â”‚
                    â”‚   (MySQL)       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®æµè½¬è¿‡ç¨‹

```java
// æ•°æ®è¯»å–æµç¨‹
public Homo<Map<String, byte[]>> getData(String logicType, String ownerId, List<String> fields) {
    return byteStorage.get(logicType, ownerId, fields)
        .nextDo(cachedData -> {
            if (cachedData != null && !cachedData.isEmpty()) {
                // 1. ä» Redis ç¼“å­˜è·å–æ•°æ®
                log.debug("ä» Redis ç¼“å­˜è·å–æ•°æ®: logicType={}, ownerId={}", logicType, ownerId);
                return Homo.result(cachedData);
            } else {
                // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œä» MySQL åŠ è½½æ•°æ®
                return loadFromDatabase(logicType, ownerId, fields)
                    .nextDo(dbData -> {
                        if (dbData != null && !dbData.isEmpty()) {
                            // 3. å°†æ•°æ®å†™å…¥ Redis ç¼“å­˜
                            return byteStorage.update(logicType, ownerId, dbData)
                                .nextDo(updateResult -> Homo.result(dbData));
                        } else {
                            return Homo.result(new HashMap<>());
                        }
                    });
            }
        });
}

// æ•°æ®å†™å…¥æµç¨‹
public Homo<Boolean> updateData(String logicType, String ownerId, Map<String, byte[]> data) {
    return byteStorage.update(logicType, ownerId, data)
        .nextDo(updateResult -> {
            if (updateResult.getKey()) {
                // 1. æ•°æ®å†™å…¥ Redis æˆåŠŸ
                // 2. æ ‡è®°ä¸ºè„æ•°æ®ï¼Œç­‰å¾…è½åœ°
                markAsDirty(logicType, ownerId, data.keySet());
                return Homo.result(true);
            } else {
                return Homo.result(false);
            }
        });
}
```

## æ ¸å¿ƒç»„ä»¶

### 1. ByteStorage

å­—èŠ‚çº§å­˜å‚¨æ¥å£ï¼š

```java
public interface ByteStorage {
    
    // æ›´æ–°æ•°æ®
    Homo<Pair<Boolean, Map<String, byte[]>>> update(String logicType, String ownerId, Map<String, byte[]> data);
    
    // è·å–æ•°æ®
    Homo<Map<String, byte[]>> get(String logicType, String ownerId, List<String> fields);
    
    // è·å–æ‰€æœ‰æ•°æ®
    Homo<Map<String, byte[]>> getAll(String logicType, String ownerId);
    
    // åˆ é™¤æ•°æ®
    Homo<Boolean> removeKeys(String logicType, String ownerId, List<String> fields);
    
    // è‡ªå¢æ“ä½œ
    Homo<Pair<Boolean, Map<String, Long>>> incr(String logicType, String ownerId, Map<String, Long> incrData);
}
```

### 2. ObjStorage

å¯¹è±¡çº§å­˜å‚¨æ¥å£ï¼š

```java
public interface ObjStorage {
    
    // ä¿å­˜å¯¹è±¡
    <T extends SaveObject> Homo<Boolean> save(T obj);
    
    // åŠ è½½å¯¹è±¡
    <T extends SaveObject> Homo<T> load(String logicType, String ownerId, Class<T> clazz);
    
    // ä¿å­˜æŒ‡å®šå­—æ®µ
    <T extends Serializable> Homo<Boolean> save(String appId, String regionId, String logicType, 
                                               String ownerId, String key, T obj);
    
    // åŠ è½½æŒ‡å®šå­—æ®µ
    <T extends Serializable> Homo<T> load(String appId, String regionId, String logicType, 
                                          String ownerId, String key, Class<T> clazz);
}
```

### 3. StorageDriver

å­˜å‚¨é©±åŠ¨æ¥å£ï¼š

```java
public interface StorageDriver extends Driver {
    
    // è·å–å­—æ®µæ•°æ®
    Homo<Map<String, byte[]>> asyncGetByFields(String appId, String regionId, String logicType, 
                                               String ownerId, List<String> fieldList);
    
    // è·å–æ‰€æœ‰æ•°æ®
    Homo<Map<String, byte[]>> asyncGetAll(String appId, String regionId, String logicType, String ownerId);
    
    // æ›´æ–°æ•°æ®
    Homo<Pair<Boolean, Map<String, byte[]>>> asyncUpdate(String appId, String regionId, String logicType, 
                                                         String ownerId, Map<String, byte[]> data);
    
    // è‡ªå¢æ“ä½œ
    Homo<Pair<Boolean, Map<String, Long>>> asyncIncr(String appId, String regionId, String logicType, 
                                                     String ownerId, Map<String, Long> incrData);
    
    // åˆ é™¤å­—æ®µ
    Homo<Boolean> asyncRemoveKeys(String appId, String regionId, String logicType, 
                                  String ownerId, List<String> remKeys);
}
```

## è„æ•°æ®ç®¡ç†

### 1. DirtyDriver

è„æ•°æ®é©±åŠ¨æ¥å£ï¼š

```java
public interface DirtyDriver {
    
    // è®°å½•è„æ•°æ®
    Homo<Long> dirtyUpdate(Dirty dirty);
    
    // é€‰æ‹©è„è¡¨
    String chooseDirtyMap();
    
    // é”å®šè„è¡¨
    Boolean lockDirtyMap(String dirtyName);
    
    // è§£é”è„è¡¨
    Boolean unlockDirtyMap(String dirtyName);
    
    // è·å–è„æ•°æ®åˆ—è¡¨
    List getDirtyList(String key, String index, String count);
    
    // åˆ›å»ºå¿«ç…§
    String snapShot(String dirtyName);
    
    // æ‰§è¡Œè½åœ°
    boolean landing(String dirtyTableName, String dirtySavingTableName);
}
```

### 2. è„æ•°æ®å¤„ç†æµç¨‹

```java
@Component
public class DirtyDataProcessor {
    
    @Autowired
    private DirtyDriver dirtyDriver;
    
    // å¤„ç†è„æ•°æ®
    public void processDirtyData() {
        String dirtyTableName = dirtyDriver.chooseDirtyMap();
        
        if (dirtyDriver.lockDirtyMap(dirtyTableName)) {
            try {
                // 1. åˆ›å»ºå¿«ç…§
                String snapshotName = dirtyDriver.snapShot(dirtyTableName);
                
                // 2. æ‰¹é‡å¤„ç†è„æ•°æ®
                processDirtyBatch(snapshotName);
                
            } finally {
                // 3. é‡Šæ”¾é”
                dirtyDriver.unlockDirtyMap(dirtyTableName);
            }
        }
    }
    
    private void processDirtyBatch(String snapshotName) {
        int batchSize = 1000;
        int offset = 0;
        
        while (true) {
            List<String> dirtyKeys = dirtyDriver.getDirtyList(snapshotName, String.valueOf(offset), String.valueOf(batchSize));
            
            if (dirtyKeys.isEmpty()) {
                break;
            }
            
            // æ‰¹é‡è½åœ°æ•°æ®
            boolean success = dirtyDriver.landing(snapshotName, snapshotName + "_saving");
            
            if (success) {
                offset += batchSize;
                log.info("è„æ•°æ®å¤„ç†æˆåŠŸ: batchSize={}, offset={}", dirtyKeys.size(), offset);
            } else {
                log.error("è„æ•°æ®å¤„ç†å¤±è´¥: batchSize={}, offset={}", dirtyKeys.size(), offset);
                break;
            }
        }
    }
}
```

## è½åœ°é©±åŠ¨

### 1. LandingDriver

è½åœ°é©±åŠ¨æ¥å£ï¼š

```java
public interface LandingDriver<T> {
    
    // çƒ­åŠ è½½æ‰€æœ‰å­—æ®µ
    Homo<Boolean> hotAllField(String appId, String regionId, String logicType, 
                              String ownerId, String redisKey);
    
    // çƒ­åŠ è½½æŒ‡å®šå­—æ®µ
    Homo<List<T>> hotFields(String appId, String regionId, String logicType, 
                            String ownerId, String redisKey, List<String> fields);
    
    // æ‰¹é‡è½åœ°
    boolean batchLanding(String dirtyTableName, List<String> dirtyList);
    
    // å•ä¸ªè½åœ°
    boolean singleLanding(List<String> dirtyList, String dirtyName);
}
```

### 2. æ•°æ®è½åœ°æµç¨‹

```java
@Component
public class DataLandingProcessor {
    
    @Autowired
    private LandingDriver<DataObject> landingDriver;
    
    // æ‰§è¡Œæ•°æ®è½åœ°
    public void executeLanding(String dirtyTableName, List<String> dirtyKeys) {
        try {
            // 1. æ‰¹é‡è½åœ°
            boolean batchSuccess = landingDriver.batchLanding(dirtyTableName, dirtyKeys);
            
            if (batchSuccess) {
                log.info("æ‰¹é‡è½åœ°æˆåŠŸ: tableName={}, keyCount={}", dirtyTableName, dirtyKeys.size());
            } else {
                // 2. æ‰¹é‡å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å•ä¸ªè½åœ°
                log.warn("æ‰¹é‡è½åœ°å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å•ä¸ªè½åœ°: tableName={}", dirtyTableName);
                executeSingleLanding(dirtyTableName, dirtyKeys);
            }
            
        } catch (Exception e) {
            log.error("æ•°æ®è½åœ°å¼‚å¸¸: tableName={}", dirtyTableName, e);
            // 3. å¼‚å¸¸æƒ…å†µï¼Œè®°å½•åˆ°é”™è¯¯è¡¨
            recordErrorData(dirtyTableName, dirtyKeys, e);
        }
    }
    
    private void executeSingleLanding(String dirtyTableName, List<String> dirtyKeys) {
        for (String dirtyKey : dirtyKeys) {
            try {
                boolean success = landingDriver.singleLanding(Arrays.asList(dirtyKey), dirtyTableName);
                if (success) {
                    log.debug("å•ä¸ªè½åœ°æˆåŠŸ: key={}", dirtyKey);
                } else {
                    log.warn("å•ä¸ªè½åœ°å¤±è´¥: key={}", dirtyKey);
                }
            } catch (Exception e) {
                log.error("å•ä¸ªè½åœ°å¼‚å¸¸: key={}", dirtyKey, e);
            }
        }
    }
}
```

## é…ç½®è¯¦è§£

### 1. Redis é…ç½®

```properties
# Redis è¿æ¥é…ç½®
homo.redis.url=redis://localhost:6379
homo.redis.port=6379
homo.redis.auth=
homo.redis.dataBase=0
homo.redis.timeOutMs=300000

# è¿æ¥æ± é…ç½®
homo.redis.maxTotal=100
homo.redis.maxIdle=10
homo.redis.minIdle=10
homo.redis.maxWaitMillis=-1
homo.redis.testOnBorrow=false
homo.redis.soTimeOut=30000

# å­˜å‚¨é”®æ¨¡æ¿
homo.storage.redis.key.template=slug-data:{%s:%s:%s:%s}
```

### 2. MySQL é…ç½®

```properties
# MySQL è¿æ¥é…ç½®
homo.datasource.url=jdbc:mysql://localhost:3306/game_db
homo.datasource.username=root
homo.datasource.password=password
homo.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# è¿æ¥æ± é…ç½®
homo.datasource.initialSize=5
homo.datasource.minIdle=5
homo.datasource.maxActive=20
homo.datasource.maxWait=60000
homo.datasource.timeBetweenEvictionRunsMillis=300000
homo.datasource.minEvictableIdleTimeMillis=300000

# è¡¨é…ç½®
homo.storage.mysql.table.prefix=homo_storage
```

### 3. è„æ•°æ®é…ç½®

```properties
# è„è¡¨é…ç½®
homo.dirty.tableNum=1
homo.dirty.table.prefix=dirtyKey
homo.dirty.lock.expireTime=1000
homo.dirty.snapshot.suffix=saving
homo.dirty.lock.error.suffix=error
homo.dirty.landing.batchNum=1000
homo.dirty.landing.delayTime=10000
```

## æœ€ä½³å®è·µ

### 1. æ•°æ®æ¨¡å‹è®¾è®¡

```java
// âœ… å¥½çš„åšæ³•ï¼šæ¸…æ™°çš„æ•°æ®æ¨¡å‹
@Data
public class UserData implements SaveObject {
    private String userId;
    private String nickName;
    private Integer level;
    private Long exp;
    private Long createTime;
    private Long updateTime;
    
    @Override
    public String getLogicType() {
        return "UserData";
    }
    
    @Override
    public String getOwnerId() {
        return userId;
    }
}

// âŒ é¿å…ï¼šæ··ä¹±çš„æ•°æ®æ¨¡å‹
public class BadUserData implements SaveObject {
    private Map<String, Object> data;  // æ‰€æœ‰æ•°æ®æ”¾åœ¨ä¸€ä¸ª Map ä¸­
    private String everything;         // ä½¿ç”¨å­—ç¬¦ä¸²å­˜å‚¨å¤æ‚æ•°æ®
}
```

### 2. å­˜å‚¨æ“ä½œ

```java
// âœ… å¥½çš„åšæ³•ï¼šåˆç†çš„æ‰¹é‡æ“ä½œ
public Homo<Boolean> batchUpdateUserData(List<UserData> userDataList) {
    Map<String, Map<String, byte[]>> batchData = new HashMap<>();
    
    for (UserData userData : userDataList) {
        Map<String, byte[]> userDataMap = new HashMap<>();
        userDataMap.put("nickName", userData.getNickName().getBytes());
        userDataMap.put("level", String.valueOf(userData.getLevel()).getBytes());
        userDataMap.put("exp", String.valueOf(userData.getExp()).getBytes());
        
        batchData.put(userData.getUserId(), userDataMap);
    }
    
    return byteStorage.batchUpdate("UserData", batchData);
}

// âŒ é¿å…ï¼šå¾ªç¯å•ä¸ªæ“ä½œ
public Homo<Boolean> badBatchUpdateUserData(List<UserData> userDataList) {
    for (UserData userData : userDataList) {
        // å¤šæ¬¡æ•°æ®åº“æ“ä½œï¼Œæ€§èƒ½å·®
        byteStorage.update("UserData", userData.getUserId(), convertToMap(userData));
    }
    return Homo.result(true);
}
```

### 3. é”™è¯¯å¤„ç†

```java
// âœ… å¥½çš„åšæ³•ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†
public Homo<Map<String, byte[]>> getUserDataSafely(String userId, List<String> fields) {
    return byteStorage.get("UserData", userId, fields)
        .onErrorContinue(throwable -> {
            log.error("è·å–ç”¨æˆ·æ•°æ®å¤±è´¥: userId={}, fields={}", userId, fields, throwable);
            return Homo.result(new HashMap<>());
        });
}
```

### 4. æ€§èƒ½ä¼˜åŒ–

```java
// âœ… ä½¿ç”¨è¿æ¥æ± 
@Configuration
public class StorageConfig {
    
    @Bean
    public RedisConnectionPoolConfig redisPoolConfig() {
        RedisConnectionPoolConfig config = new RedisConnectionPoolConfig();
        config.setMaxTotal(200);
        config.setMaxIdle(20);
        config.setMinIdle(10);
        config.setMaxWaitMillis(5000);
        return config;
    }
    
    @Bean
    public DataSourceConfig mysqlDataSourceConfig() {
        DataSourceConfig config = new DataSourceConfig();
        config.setMaxActive(50);
        config.setMinIdle(10);
        config.setMaxWait(30000);
        return config;
    }
}
```

## ç›‘æ§å’Œè°ƒè¯•

### 1. å­˜å‚¨ç›‘æ§

```java
@Component
public class StorageMonitor {
    
    private final MeterRegistry meterRegistry;
    
    public StorageMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }
    
    public void recordStorageOperation(String operation, boolean success, Duration duration) {
        Timer.builder("storage.operation.duration")
            .tag("operation", operation)
            .tag("success", String.valueOf(success))
            .register(meterRegistry)
            .record(duration);
    }
    
    public void recordCacheHit(String cacheType, boolean hit) {
        Counter.builder("storage.cache.hit")
            .tag("cacheType", cacheType)
            .tag("hit", String.valueOf(hit))
            .register(meterRegistry)
            .increment();
    }
}
```

### 2. å¥åº·æ£€æŸ¥

```java
@RestController
public class StorageHealthController {
    
    @Autowired
    private ByteStorage byteStorage;
    
    @GetMapping("/health/storage")
    public Map<String, Object> checkStorageHealth() {
        Map<String, Object> health = new HashMap<>();
        
        try {
            // æ£€æŸ¥ Redis è¿æ¥
            byteStorage.get("HealthCheck", "test", Arrays.asList("test"))
                .block(Duration.ofSeconds(5));
            health.put("redis", "UP");
        } catch (Exception e) {
            health.put("redis", "DOWN");
            health.put("redisError", e.getMessage());
        }
        
        try {
            // æ£€æŸ¥ MySQL è¿æ¥
            // è¿™é‡Œå¯ä»¥æ·»åŠ  MySQL å¥åº·æ£€æŸ¥é€»è¾‘
            health.put("mysql", "UP");
        } catch (Exception e) {
            health.put("mysql", "DOWN");
            health.put("mysqlError", e.getMessage());
        }
        
        return health;
    }
}
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Redis è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ Redis æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
   - ç¡®è®¤è¿æ¥é…ç½®å’Œç½‘ç»œè¿æ¥
   - æŸ¥çœ‹ Redis æ—¥å¿—

2. **MySQL è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ MySQL æœåŠ¡çŠ¶æ€
   - ç¡®è®¤æ•°æ®åº“è¿æ¥é…ç½®
   - æŸ¥çœ‹è¿æ¥æ± é…ç½®

3. **æ•°æ®ä¸ä¸€è‡´**
   - æ£€æŸ¥è„æ•°æ®å¤„ç†çŠ¶æ€
   - ç¡®è®¤è½åœ°ä»»åŠ¡æ˜¯å¦æ­£å¸¸æ‰§è¡Œ
   - æŸ¥çœ‹æ•°æ®åŒæ­¥æ—¥å¿—

### è°ƒè¯•æŠ€å·§

```java
// å¯ç”¨è¯¦ç»†æ—¥å¿—
logging.level.com.homo.core.storage=DEBUG
logging.level.com.homo.core.redis=DEBUG
logging.level.com.homo.core.mysql=DEBUG

// æ·»åŠ å­˜å‚¨è¿½è¸ª
@Component
public class StorageTracer {
    
    public void traceStorageOperation(String operation, String logicType, String ownerId) {
        log.debug("å­˜å‚¨æ“ä½œ: operation={}, logicType={}, ownerId={}", operation, logicType, ownerId);
    }
}
```

## ç›¸å…³é“¾æ¥

- [homo-core æ¡†æ¶æ–‡æ¡£](../README.md)
- [Redis å®˜æ–¹æ–‡æ¡£](https://redis.io/documentation)
- [MySQL å®˜æ–¹æ–‡æ¡£](https://dev.mysql.com/doc/)
- [å“åº”å¼ç¼–ç¨‹æŒ‡å—](https://projectreactor.io/docs/core/release/reference/)
