# æ–‡æ¡£æ•°æ®åº“ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

homo-core æ–‡æ¡£æ•°æ®åº“æ¨¡å—åŸºäº MongoDB å®ç°äº†å“åº”å¼çš„æ–‡æ¡£å­˜å‚¨èƒ½åŠ›ï¼Œç‰¹åˆ«é€‚ç”¨äºæ¸¸æˆæœåŠ¡å™¨ä¸­éœ€è¦å­˜å‚¨å¤æ‚åµŒå¥—æ•°æ®ç»“æ„çš„åœºæ™¯ã€‚æ”¯æŒçµæ´»çš„æ–‡æ¡£æŸ¥è¯¢ã€èšåˆæ“ä½œå’Œç´¢å¼•ç®¡ç†ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ“„ **æ–‡æ¡£å­˜å‚¨**: æ”¯æŒå¤æ‚åµŒå¥—çš„ JSON æ–‡æ¡£å­˜å‚¨
- ğŸ” **çµæ´»æŸ¥è¯¢**: æ”¯æŒä¸°å¯Œçš„æŸ¥è¯¢æ¡ä»¶å’Œèšåˆæ“ä½œ
- ğŸ“Š **ç´¢å¼•ç®¡ç†**: è‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†æ•°æ®åº“ç´¢å¼•
- âš¡ **å“åº”å¼**: åŸºäºå“åº”å¼ç¼–ç¨‹ï¼Œæ”¯æŒé«˜å¹¶å‘æ“ä½œ
- ğŸ”„ **å…³è”æŸ¥è¯¢**: æ”¯æŒæ–‡æ¡£é—´çš„å…³è”æŸ¥è¯¢ (Lookup)
- ğŸ›¡ï¸ **ç±»å‹å®‰å…¨**: æ”¯æŒå¼ºç±»å‹æ–‡æ¡£æ˜ å°„

## ç¯å¢ƒè¦æ±‚

- **JDK**: 8 æˆ–æ›´é«˜ç‰ˆæœ¬
- **MongoDB**: 4.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Maven**: 3.6.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Apollo é…ç½®ä¸­å¿ƒ**: ç”¨äºé…ç½®ç®¡ç†

## å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ ä¾èµ–

```xml
<dependencies>
    <!-- æ–‡æ¡£å­˜å‚¨åŸºç¡€æ¨¡å— -->
    <dependency>
        <groupId>com.homo</groupId>
        <artifactId>homo-core-storage</artifactId>
    </dependency>
    
    <!-- MongoDB é©±åŠ¨ -->
    <dependency>
        <groupId>com.homo</groupId>
        <artifactId>homo-core-document-mongo</artifactId>
    </dependency>
</dependencies>
```

### 2. é…ç½® MongoDB

åœ¨ `application.properties` ä¸­é…ç½®ï¼š

```properties
# Apollo é…ç½®
apollo.bootstrap.enabled=true
apollo.bootstrap.namespaces=application,mongo_connect_info

# MongoDB é…ç½®
homo.mongo.enable=true
homo.mongo.connString=mongodb://localhost:27017
homo.mongo.database=game_storage
homo.mongo.minSize=1
homo.mongo.maxSize=100
homo.mongo.maxWaitTime=100
homo.mongo.maxConnectionIdleTime=10000
homo.mongo.maxConnectionLifeTime=60000
homo.mongo.retryWrites=true
homo.mongo.readPreference=primary
homo.mongo.writeConcern=ACKNOWLEDGED
```

### 3. å®šä¹‰æ–‡æ¡£æ¨¡å‹

```java
@Slf4j
@BsonDiscriminator
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Document(collectionName = "user_profiles", 
          indexes = {"value.nickName", "value.level", "value.registerTime"})
public class UserProfile implements Serializable {
    
    private String userId;
    private String nickName;
    private Integer level;
    private Long exp;
    private Integer sex;                    // æ€§åˆ« 0ç”· 1å¥³
    private String avatar;
    private String identityId;              // èº«ä»½è¯
    private String identityIdName;          // èº«ä»½è¯å§“å
    private Double totalCharge;             // æ€»å……å€¼é‡‘é¢
    private Integer groupValue;             // æˆé•¿å€¼
    private String imei;                    // è®¾å¤‡æ ‡è¯†
    private String platform;                // ç³»ç»Ÿç±»å‹ ios/android
    private String deviceType;              // æ‰‹æœºå‹å·
    private String token;                   // ç™»å½•token
    
    private Long registerTime;              // æ³¨å†Œæ—¶é—´
    private Long inMemberTime;              // æˆä¸ºä¼šå‘˜æ—¶é—´
    private Long lastLoginTime;             // æœ€åç™»å½•æ—¶é—´
    private Long lastChargeTime;            // æœ€åå……å€¼æ—¶é—´
    
    // æ¸¸æˆç›¸å…³æ•°æ®
    private Map<String, Object> gameData;   // æ¸¸æˆæ•°æ®
    private List<String> achievements;      // æˆå°±åˆ—è¡¨
    private List<FriendInfo> friends;       // å¥½å‹åˆ—è¡¨
    
    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class FriendInfo {
        private String friendId;
        private String friendName;
        private Integer friendLevel;
        private Long addTime;
    }
}
```

### 4. ä½¿ç”¨ DocumentStorage

```java
@Service
public class UserProfileService extends BaseService {
    
    @Autowired
    private DocumentStorage<Bson, Bson, Bson, List<Bson>> documentStorage;
    
    private static final String USER_LOGIC_TYPE = "UserProfile";
    
    // åˆ›å»ºç”¨æˆ·æ¡£æ¡ˆ
    public Homo<CreateUserProfileResp> createUserProfile(CreateUserProfileReq req) {
        log.info("åˆ›å»ºç”¨æˆ·æ¡£æ¡ˆ: userId={}", req.getUserId());
        
        String userId = req.getUserId();
        return documentStorage.get(USER_LOGIC_TYPE, userId, "data", UserProfile.class)
            .nextDo(existingProfile -> {
                if (existingProfile != null) {
                    return Homo.error(new RuntimeException("ç”¨æˆ·æ¡£æ¡ˆå·²å­˜åœ¨"));
                }
                
                UserProfile newProfile = UserProfile.builder()
                    .userId(userId)
                    .nickName(req.getNickName())
                    .level(1)
                    .exp(0L)
                    .sex(req.getSex())
                    .registerTime(System.currentTimeMillis())
                    .lastLoginTime(System.currentTimeMillis())
                    .gameData(new HashMap<>())
                    .achievements(new ArrayList<>())
                    .friends(new ArrayList<>())
                    .build();
                
                return documentStorage.save(USER_LOGIC_TYPE, userId, "data", newProfile, UserProfile.class)
                    .nextDo(saveResult -> {
                        CreateUserProfileResp resp = CreateUserProfileResp.newBuilder()
                            .setErrorCode(0)
                            .setErrorDesc("åˆ›å»ºæˆåŠŸ")
                            .setUserProfile(convertToProto(newProfile))
                            .build();
                        return Homo.result(resp);
                    });
            })
            .onErrorContinue(throwable -> {
                CreateUserProfileResp resp = CreateUserProfileResp.newBuilder()
                    .setErrorCode(1)
                    .setErrorDesc("åˆ›å»ºå¤±è´¥: " + throwable.getMessage())
                    .build();
                return Homo.result(resp);
            });
    }
    
    // æŸ¥è¯¢ç”¨æˆ·æ¡£æ¡ˆ
    public Homo<GetUserProfileResp> getUserProfile(GetUserProfileReq req) {
        log.info("æŸ¥è¯¢ç”¨æˆ·æ¡£æ¡ˆ: userId={}", req.getUserId());
        
        return documentStorage.get(USER_LOGIC_TYPE, req.getUserId(), "data", UserProfile.class)
            .nextDo(profile -> {
                GetUserProfileResp resp;
                if (profile != null) {
                    resp = GetUserProfileResp.newBuilder()
                        .setErrorCode(0)
                        .setErrorDesc("æŸ¥è¯¢æˆåŠŸ")
                        .setUserProfile(convertToProto(profile))
                        .build();
                } else {
                    resp = GetUserProfileResp.newBuilder()
                        .setErrorCode(1)
                        .setErrorDesc("ç”¨æˆ·æ¡£æ¡ˆä¸å­˜åœ¨")
                        .build();
                }
                return Homo.result(resp);
            });
    }
}
```

## æ ¸å¿ƒæ³¨è§£

### @Document

å®šä¹‰æ–‡æ¡£é›†åˆçš„åŸºæœ¬ä¿¡æ¯ï¼š

```java
@Document(
    collectionName = "collection_name",  // é›†åˆåç§°
    indexes = {"field1", "field2"},     // ç´¢å¼•å­—æ®µ
    indexType = IndexType.ASC           // ç´¢å¼•ç±»å‹
)

public enum IndexType {
    ASC,   // å‡åºç´¢å¼•
    DESC   // é™åºç´¢å¼•
}
```

### @BsonDiscriminator

ç”¨äºå¤šæ€æ–‡æ¡£çš„åŒºåˆ†ï¼š

```java
@BsonDiscriminator
public abstract class BaseDocument {
    // åŸºç¡€å­—æ®µ
}

@BsonDiscriminator("user")
public class UserDocument extends BaseDocument {
    // ç”¨æˆ·ç‰¹å®šå­—æ®µ
}

@BsonDiscriminator("admin")
public class AdminDocument extends BaseDocument {
    // ç®¡ç†å‘˜ç‰¹å®šå­—æ®µ
}
```

## æ•°æ®æ“ä½œ

### åŸºæœ¬ CRUD æ“ä½œ

```java
@Service
public class DocumentCrudService {
    
    @Autowired
    private DocumentStorage<Bson, Bson, Bson, List<Bson>> documentStorage;
    
    // ä¿å­˜æ–‡æ¡£
    public Homo<Boolean> saveDocument(String logicType, String ownerId, Object document) {
        return documentStorage.save(logicType, ownerId, "data", document, document.getClass())
            .nextDo(result -> {
                log.info("æ–‡æ¡£ä¿å­˜ç»“æœ: {}", result);
                return Homo.result(result);
            });
    }
    
    // è·å–æ–‡æ¡£
    public <T> Homo<T> getDocument(String logicType, String ownerId, Class<T> clazz) {
        return documentStorage.get(logicType, ownerId, "data", clazz)
            .nextDo(document -> {
                if (document != null) {
                    log.info("æŸ¥è¯¢åˆ°æ–‡æ¡£: {}", document);
                } else {
                    log.info("æ–‡æ¡£ä¸å­˜åœ¨");
                }
                return Homo.result(document);
            });
    }
    
    // æ›´æ–°æ–‡æ¡£
    public Homo<Boolean> updateDocument(String logicType, String ownerId, Object document) {
        return documentStorage.save(logicType, ownerId, "data", document, document.getClass())
            .nextDo(result -> {
                log.info("æ–‡æ¡£æ›´æ–°ç»“æœ: {}", result);
                return Homo.result(result);
            });
    }
    
    // åˆ é™¤æ–‡æ¡£
    public Homo<Boolean> deleteDocument(String logicType, String ownerId) {
        return documentStorage.removeKeys(logicType, ownerId, Arrays.asList("data"), Object.class)
            .nextDo(result -> {
                log.info("æ–‡æ¡£åˆ é™¤ç»“æœ: {}", result);
                return Homo.result(result);
            });
    }
}
```

### æŸ¥è¯¢æ“ä½œ

```java
@Service
public class DocumentQueryService {
    
    @Autowired
    private DocumentStorage<Bson, Bson, Bson, List<Bson>> documentStorage;
    
    // æ¡ä»¶æŸ¥è¯¢
    public Homo<List<UserProfile>> queryUsersByLevel(int minLevel) {
        Bson filter = Filters.and(
            Filters.eq("value.level", minLevel),
            Filters.eq("isDel", 0)  // æœªåˆ é™¤
        );
        
        Bson sort = Sorts.descending("value.registerTime");
        
        return documentStorage.query(filter, sort, 100, 0, UserProfile.class)
            .nextDo(users -> {
                log.info("æŸ¥è¯¢åˆ°ç”¨æˆ·æ•°é‡: {}", users.size());
                return Homo.result(users);
            });
    }
    
    // èŒƒå›´æŸ¥è¯¢
    public Homo<List<UserProfile>> queryUsersByRegisterTime(long startTime, long endTime) {
        Bson filter = Filters.and(
            Filters.gte("value.registerTime", startTime),
            Filters.lte("value.registerTime", endTime),
            Filters.eq("isDel", 0)
        );
        
        return documentStorage.query(filter, null, 0, 0, UserProfile.class)
            .nextDo(users -> {
                log.info("æ—¶é—´èŒƒå›´å†…ç”¨æˆ·æ•°é‡: {}", users.size());
                return Homo.result(users);
            });
    }
    
    // æ¨¡ç³ŠæŸ¥è¯¢
    public Homo<List<UserProfile>> searchUsersByName(String namePattern) {
        Bson filter = Filters.and(
            Filters.regex("value.nickName", namePattern, "i"),  // å¿½ç•¥å¤§å°å†™
            Filters.eq("isDel", 0)
        );
        
        return documentStorage.query(filter, null, 50, 0, UserProfile.class)
            .nextDo(users -> {
                log.info("æœç´¢åˆ°ç”¨æˆ·æ•°é‡: {}", users.size());
                return Homo.result(users);
            });
    }
    
    // å¤åˆæ¡ä»¶æŸ¥è¯¢
    public Homo<List<UserProfile>> queryVipUsers(int minLevel, double minCharge) {
        Bson filter = Filters.and(
            Filters.gte("value.level", minLevel),
            Filters.gte("value.totalCharge", minCharge),
            Filters.eq("isDel", 0)
        );
        
        Bson sort = Sorts.descending("value.totalCharge");
        
        return documentStorage.query(filter, sort, 100, 0, UserProfile.class)
            .nextDo(users -> {
                log.info("VIPç”¨æˆ·æ•°é‡: {}", users.size());
                return Homo.result(users);
            });
    }
}
```

### èšåˆæ“ä½œ

```java
@Service
public class DocumentAggregateService {
    
    @Autowired
    private DocumentStorage<Bson, Bson, Bson, List<Bson>> documentStorage;
    
    // ç»Ÿè®¡ç”¨æˆ·ç­‰çº§åˆ†å¸ƒ
    public Homo<List<UserLevelStats>> getUserLevelStats() {
        List<Bson> pipeline = Arrays.asList(
            Aggregates.match(Filters.eq("isDel", 0)),
            Aggregates.group("$value.level", 
                Accumulators.sum("count", 1),
                Accumulators.avg("avgExp", "$value.exp"),
                Accumulators.sum("totalCharge", "$value.totalCharge")
            ),
            Aggregates.sort(Sorts.ascending("_id"))
        );
        
        return documentStorage.aggregate(pipeline, UserLevelStats.class, UserProfile.class)
            .nextDo(stats -> {
                log.info("ç­‰çº§ç»Ÿè®¡ç»“æœ: {}", stats);
                return Homo.result(stats);
            });
    }
    
    // å…³è”æŸ¥è¯¢ç”¨æˆ·å’Œè®¢å•
    public Homo<List<UserOrderInfo>> getUsersWithOrders() {
        List<Bson> pipeline = Arrays.asList(
            Aggregates.match(Filters.eq("isDel", 0)),
            Aggregates.project(Projections.fields(
                Projections.include("value.userId", "value.nickName", "value.level")
            )),
            Aggregates.lookup("order_info", "value.userId", "userId", "orders"),
            Aggregates.match(Filters.exists("orders.0")),  // åªæŸ¥è¯¢æœ‰è®¢å•çš„ç”¨æˆ·
            Aggregates.limit(100)
        );
        
        return documentStorage.aggregate(pipeline, UserOrderInfo.class, UserProfile.class)
            .nextDo(results -> {
                log.info("ç”¨æˆ·è®¢å•å…³è”æŸ¥è¯¢ç»“æœ: {}", results.size());
                return Homo.result(results);
            });
    }
    
    // å¤æ‚èšåˆï¼šç”¨æˆ·æ´»è·ƒåº¦åˆ†æ
    public Homo<List<UserActivityStats>> getUserActivityStats() {
        List<Bson> pipeline = Arrays.asList(
            Aggregates.match(Filters.and(
                Filters.eq("isDel", 0),
                Filters.gte("value.lastLoginTime", System.currentTimeMillis() - 7 * 24 * 60 * 60 * 1000)  // æœ€è¿‘7å¤©
            )),
            Aggregates.group("$value.platform",
                Accumulators.sum("userCount", 1),
                Accumulators.avg("avgLevel", "$value.level"),
                Accumulators.avg("avgExp", "$value.exp"),
                Accumulators.sum("totalCharge", "$value.totalCharge")
            ),
            Aggregates.sort(Sorts.descending("userCount"))
        );
        
        return documentStorage.aggregate(pipeline, UserActivityStats.class, UserProfile.class)
            .nextDo(stats -> {
                log.info("ç”¨æˆ·æ´»è·ƒåº¦ç»Ÿè®¡: {}", stats);
                return Homo.result(stats);
            });
    }
}
```

### æ›´æ–°æ“ä½œ

```java
@Service
public class DocumentUpdateService {
    
    @Autowired
    private DocumentStorage<Bson, Bson, Bson, List<Bson>> documentStorage;
    
    // æ›´æ–°ç”¨æˆ·ç­‰çº§
    public Homo<Boolean> updateUserLevel(String userId, int newLevel) {
        Map<String, Object> updateData = new HashMap<>();
        updateData.put("level", newLevel);
        updateData.put("updateTime", System.currentTimeMillis());
        
        return documentStorage.updatePartial("UserProfile", "region1", userId, "data", updateData, UserProfile.class)
            .nextDo(result -> {
                log.info("ç”¨æˆ·ç­‰çº§æ›´æ–°ç»“æœ: {}", result);
                return Homo.result(result);
            });
    }
    
    // å¢åŠ ç”¨æˆ·ç»éªŒ
    public Homo<Boolean> addUserExp(String userId, long exp) {
        Map<String, Long> incrData = new HashMap<>();
        incrData.put("exp", exp);
        
        return documentStorage.incr("UserProfile", "region1", userId, "data", incrData, UserProfile.class)
            .nextDo(result -> {
                log.info("ç”¨æˆ·ç»éªŒå¢åŠ ç»“æœ: {}", result);
                return Homo.result(result.getKey());
            });
    }
    
    // æ·»åŠ æˆå°±
    public Homo<Boolean> addAchievement(String userId, String achievement) {
        return documentStorage.get("UserProfile", "region1", userId, "data", UserProfile.class)
            .nextDo(profile -> {
                if (profile == null) {
                    return Homo.error(new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨"));
                }
                
                if (profile.getAchievements() == null) {
                    profile.setAchievements(new ArrayList<>());
                }
                
                if (!profile.getAchievements().contains(achievement)) {
                    profile.getAchievements().add(achievement);
                    return documentStorage.save("UserProfile", "region1", userId, "data", profile, UserProfile.class);
                }
                
                return Homo.result(true);
            });
    }
}
```

## ç´¢å¼•ç®¡ç†

### è‡ªåŠ¨ç´¢å¼•åˆ›å»º

```java
// åœ¨æ–‡æ¡£ç±»ä¸Šå®šä¹‰ç´¢å¼•
@Document(collectionName = "user_profiles", 
          indexes = {
              "value.nickName",           // æ˜µç§°ç´¢å¼•
              "value.level",              // ç­‰çº§ç´¢å¼•
              "value.registerTime",       // æ³¨å†Œæ—¶é—´ç´¢å¼•
              "value.totalCharge",        // å……å€¼é‡‘é¢ç´¢å¼•
              "value.platform",           // å¹³å°ç´¢å¼•
              "value.lastLoginTime"       // æœ€åç™»å½•æ—¶é—´ç´¢å¼•
          })
public class UserProfile {
    // æ–‡æ¡£å­—æ®µ
}
```

### å¤åˆç´¢å¼•

```java
// åˆ›å»ºå¤åˆç´¢å¼•
@Component
public class IndexManager {
    
    @Autowired
    private MongoHelper mongoHelper;
    
    @PostConstruct
    public void createCompoundIndexes() {
        // åˆ›å»ºå¤åˆç´¢å¼•ï¼šç­‰çº§ + ç»éªŒ
        mongoHelper.createIndex("user_profiles", 
            Indexes.compoundIndex(
                Indexes.ascending("value.level"),
                Indexes.descending("value.exp")
            ),
            new IndexOptions().name("level_exp_idx")
        );
        
        // åˆ›å»ºå¤åˆç´¢å¼•ï¼šå¹³å° + ç­‰çº§
        mongoHelper.createIndex("user_profiles",
            Indexes.compoundIndex(
                Indexes.ascending("value.platform"),
                Indexes.ascending("value.level")
            ),
            new IndexOptions().name("platform_level_idx")
        );
    }
}
```

## é…ç½®è¯¦è§£

### MongoDB è¿æ¥é…ç½®

```java
@Configuration
public class MongoConfig {
    
    @Bean
    public MongoClient mongoClient() {
        MongoClientSettings settings = MongoClientSettings.builder()
            .applyConnectionString(new ConnectionString("mongodb://localhost:27017"))
            .retryWrites(true)
            .writeConcern(WriteConcern.ACKNOWLEDGED)
            .readPreference(ReadPreference.primary())
            .applyToConnectionPoolSettings(builder -> {
                builder.minSize(1)
                       .maxSize(100)
                       .maxWaitTime(100, TimeUnit.MILLISECONDS)
                       .maxConnectionIdleTime(10000, TimeUnit.MILLISECONDS)
                       .maxConnectionLifeTime(60000, TimeUnit.MILLISECONDS);
            })
            .build();
        
        return MongoClients.create(settings);
    }
}
```

### è¿æ¥æ± é…ç½®

```properties
# è¿æ¥æ± æœ€å°è¿æ¥æ•°
homo.mongo.minSize=1

# è¿æ¥æ± æœ€å¤§è¿æ¥æ•°
homo.mongo.maxSize=100

# æœ€å¤§ç­‰å¾…æ—¶é—´ (æ¯«ç§’)
homo.mongo.maxWaitTime=100

# æœ€å¤§ç©ºé—²æ—¶é—´ (æ¯«ç§’)
homo.mongo.maxConnectionIdleTime=10000

# æœ€å¤§è¿æ¥å­˜æ´»æ—¶é—´ (æ¯«ç§’)
homo.mongo.maxConnectionLifeTime=60000

# æ˜¯å¦å¯ç”¨é‡è¯•å†™å…¥
homo.mongo.retryWrites=true

# è¯»åå¥½: primary, secondary, primaryPreferred, secondaryPreferred, nearest
homo.mongo.readPreference=primary

# å†™å…³æ³¨: UNACKNOWLEDGED, ACKNOWLEDGED, JOURNALED, MAJORITY, W1, W2, W3
homo.mongo.writeConcern=ACKNOWLEDGED
```

## æœ€ä½³å®è·µ

### 1. æ–‡æ¡£è®¾è®¡

```java
// âœ… å¥½çš„åšæ³•ï¼šåˆç†çš„æ–‡æ¡£ç»“æ„
@Document(collectionName = "user_profiles")
public class UserProfile {
    private String userId;           // ä¸»é”®
    private String nickName;         // ç”¨æˆ·æ˜µç§°
    private Integer level;           // ç”¨æˆ·ç­‰çº§
    private Long exp;               // ç»éªŒå€¼
    private Map<String, Object> gameData;  // æ¸¸æˆæ•°æ®
    private List<String> achievements;     // æˆå°±åˆ—è¡¨
    private Long createTime;        // åˆ›å»ºæ—¶é—´
    private Long updateTime;        // æ›´æ–°æ—¶é—´
}

// âŒ é¿å…ï¼šè¿‡æ·±çš„åµŒå¥—ç»“æ„
public class BadUserProfile {
    private Map<String, Map<String, Map<String, Object>>> nestedData;  // è¿‡æ·±åµŒå¥—
    private List<List<List<Object>>> complexList;                     // å¤æ‚åˆ—è¡¨
}
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```java
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨ç´¢å¼•å­—æ®µæŸ¥è¯¢
public Homo<List<UserProfile>> queryUsersByLevel(int level) {
    Bson filter = Filters.eq("value.level", level);  // ä½¿ç”¨ç´¢å¼•å­—æ®µ
    return documentStorage.query(filter, null, 100, 0, UserProfile.class);
}

// âŒ é¿å…ï¼šä½¿ç”¨éç´¢å¼•å­—æ®µæŸ¥è¯¢
public Homo<List<UserProfile>> queryUsersByNickName(String nickName) {
    Bson filter = Filters.eq("value.nickName", nickName);  // å¦‚æœæ²¡æœ‰ç´¢å¼•ï¼Œæ€§èƒ½è¾ƒå·®
    return documentStorage.query(filter, null, 100, 0, UserProfile.class);
}
```

### 3. æ‰¹é‡æ“ä½œ

```java
// âœ… å¥½çš„åšæ³•ï¼šæ‰¹é‡æŸ¥è¯¢
public Homo<List<UserProfile>> getUsersByIds(List<String> userIds) {
    Bson filter = Filters.in("value.userId", userIds);
    return documentStorage.query(filter, null, 0, 0, UserProfile.class);
}

// âŒ é¿å…ï¼šå¾ªç¯å•ä¸ªæŸ¥è¯¢
public Homo<List<UserProfile>> getUsersByIdsBad(List<String> userIds) {
    List<UserProfile> users = new ArrayList<>();
    for (String userId : userIds) {
        // å¤šæ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼Œæ€§èƒ½å·®
        documentStorage.get("UserProfile", "region1", userId, "data", UserProfile.class)
            .nextDo(user -> {
                if (user != null) {
                    users.add(user);
                }
                return Homo.result(user);
            });
    }
    return Homo.result(users);
}
```

### 4. é”™è¯¯å¤„ç†

```java
// âœ… å¥½çš„åšæ³•ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†
public Homo<UserProfile> getUserProfileSafely(String userId) {
    return documentStorage.get("UserProfile", "region1", userId, "data", UserProfile.class)
        .onErrorContinue(throwable -> {
            log.error("æŸ¥è¯¢ç”¨æˆ·æ¡£æ¡ˆå¤±è´¥: userId={}", userId, throwable);
            return Homo.result(null);
        });
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. ç´¢å¼•ä¼˜åŒ–

```java
// åˆ›å»ºåˆé€‚çš„ç´¢å¼•
@Document(collectionName = "user_profiles",
    indexes = {
        "value.userId",           // ä¸»é”®æŸ¥è¯¢
        "value.level",            // ç­‰çº§æŸ¥è¯¢
        "value.registerTime",     // æ—¶é—´èŒƒå›´æŸ¥è¯¢
        "value.platform"          // å¹³å°ç»Ÿè®¡
    })
public class UserProfile {
    // æ–‡æ¡£å­—æ®µ
}
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```java
// ä½¿ç”¨æŠ•å½±å‡å°‘æ•°æ®ä¼ è¾“
public Homo<List<UserBasicInfo>> getUserBasicInfo() {
    List<Bson> pipeline = Arrays.asList(
        Aggregates.match(Filters.eq("isDel", 0)),
        Aggregates.project(Projections.fields(
            Projections.include("value.userId", "value.nickName", "value.level")
        )),
        Aggregates.limit(100)
    );
    
    return documentStorage.aggregate(pipeline, UserBasicInfo.class, UserProfile.class);
}
```

### 3. è¿æ¥æ± ä¼˜åŒ–

```properties
# æ ¹æ®å¹¶å‘é‡è°ƒæ•´è¿æ¥æ± å¤§å°
homo.mongo.maxSize=200
homo.mongo.minSize=10
homo.mongo.maxWaitTime=5000
```

## ç›‘æ§å’Œè°ƒè¯•

### 1. æ€§èƒ½ç›‘æ§

```java
@Component
public class MongoMetrics {
    
    private final MeterRegistry meterRegistry;
    
    public MongoMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }
    
    public void recordQueryTime(String operation, Duration duration) {
        Timer.builder("mongo.query.duration")
            .tag("operation", operation)
            .register(meterRegistry)
            .record(duration);
    }
    
    public void recordQueryCount(String operation, boolean success) {
        Counter.builder("mongo.query.count")
            .tag("operation", operation)
            .tag("success", String.valueOf(success))
            .register(meterRegistry)
            .increment();
    }
}
```

### 2. å¥åº·æ£€æŸ¥

```java
@RestController
public class MongoHealthController {
    
    @Autowired
    private MongoHelper mongoHelper;
    
    @GetMapping("/health/mongo")
    public Map<String, Object> checkHealth() {
        Map<String, Object> health = new HashMap<>();
        
        try {
            // æ‰§è¡Œç®€å•æŸ¥è¯¢æ£€æŸ¥è¿æ¥
            mongoHelper.getMongoDatabase().runCommand(new Document("ping", 1));
            health.put("status", "UP");
            health.put("database", mongoHelper.getMongoDatabase().getName());
        } catch (Exception e) {
            health.put("status", "DOWN");
            health.put("error", e.getMessage());
        }
        
        return health;
    }
}
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ MongoDB æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
   - ç¡®è®¤è¿æ¥å­—ç¬¦ä¸²å’Œç«¯å£é…ç½®
   - æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

2. **æŸ¥è¯¢è¶…æ—¶**
   - æ£€æŸ¥æŸ¥è¯¢æ¡ä»¶æ˜¯å¦åˆç†
   - ç¡®è®¤ç´¢å¼•æ˜¯å¦æ­£ç¡®åˆ›å»º
   - è°ƒæ•´è¿æ¥æ± é…ç½®

3. **å†…å­˜ä¸è¶³**
   - å‡å°‘æŸ¥è¯¢ç»“æœé›†å¤§å°
   - ä½¿ç”¨æŠ•å½±å‡å°‘æ•°æ®ä¼ è¾“
   - è°ƒæ•´ JVM å†…å­˜é…ç½®

### è°ƒè¯•æŠ€å·§

```java
// å¯ç”¨è¯¦ç»†æ—¥å¿—
logging.level.com.homo.core.mongo=DEBUG
logging.level.org.mongodb.driver=DEBUG

// æ·»åŠ æŸ¥è¯¢è¿½è¸ª
@Component
public class MongoQueryTracer {
    
    public void traceQuery(String operation, Bson filter) {
        log.debug("MongoDBæŸ¥è¯¢: operation={}, filter={}", operation, filter);
    }
}
```

## ç›¸å…³é“¾æ¥

- [homo-core æ¡†æ¶æ–‡æ¡£](../README.md)
- [MongoDB å®˜æ–¹æ–‡æ¡£](https://docs.mongodb.com/)
- [MongoDB Java é©±åŠ¨æ–‡æ¡£](https://mongodb.github.io/mongo-java-driver/)
- [å“åº”å¼ç¼–ç¨‹æŒ‡å—](https://projectreactor.io/docs/core/release/reference/)
