# åˆ†å¸ƒå¼é”ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

homo-core åˆ†å¸ƒå¼é”æ¨¡å—æä¾›äº†åŸºäº Redis çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œæ”¯æŒå¼‚æ­¥å’ŒåŒæ­¥æ“ä½œï¼Œä¸ºåˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„èµ„æºè®¿é—®æ§åˆ¶æä¾›äº†å¯é çš„è§£å†³æ–¹æ¡ˆã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ”’ **åˆ†å¸ƒå¼é”**: åŸºäº Redis å®ç°çš„é«˜å¯ç”¨åˆ†å¸ƒå¼é”
- âš¡ **å¼‚æ­¥æ“ä½œ**: æ”¯æŒå¼‚æ­¥åŠ é”å’Œè§£é”æ“ä½œ
- ğŸ”„ **è‡ªåŠ¨è¿‡æœŸ**: æ”¯æŒé”çš„è‡ªåŠ¨è¿‡æœŸæœºåˆ¶ï¼Œé˜²æ­¢æ­»é”
- ğŸ›¡ï¸ **çº¿ç¨‹å®‰å…¨**: å®Œå…¨çº¿ç¨‹å®‰å…¨çš„å®ç°
- ğŸ¯ **ç®€å•æ˜“ç”¨**: æä¾›ç®€æ´çš„ API æ¥å£

## ç¯å¢ƒè¦æ±‚

- **JDK**: 8 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Redis**: 3.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **homo-core**: 1.0 æˆ–æ›´é«˜ç‰ˆæœ¬

## å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ ä¾èµ–

åœ¨é¡¹ç›®çš„ `pom.xml` ä¸­æ·»åŠ ä¾èµ–ï¼š

```xml
<dependencies>
    <!-- åˆ†å¸ƒå¼é” Redis é©±åŠ¨ -->
    <dependency>
        <groupId>com.homo</groupId>
        <artifactId>homo-core-lock-redis</artifactId>
    </dependency>
</dependencies>
```

### 2. åŸºæœ¬ä½¿ç”¨

```java
@Service
public class OrderService {
    
    @Autowired
    private LockDriver lockDriver;
    
    public void processOrder(String orderId) {
        String lockKey = "order:" + orderId;
        int expireTime = 30; // 30ç§’è¿‡æœŸ
        
        // åŒæ­¥åŠ é”
        boolean locked = lockDriver.lock("app1", "region1", "order", orderId, lockKey, expireTime);
        
        if (locked) {
            try {
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                doProcessOrder(orderId);
            } finally {
                // é‡Šæ”¾é”
                lockDriver.unlock("app1", "region1", "order", orderId, lockKey);
            }
        } else {
            throw new RuntimeException("è·å–é”å¤±è´¥");
        }
    }
}
```

## API å‚è€ƒ

### LockDriver æ¥å£

```java
public interface LockDriver extends Driver {
    
    /**
     * å¼‚æ­¥åŠ é”
     * @param appId      åº”ç”¨ID
     * @param regionId   åŒºåŸŸID
     * @param logicType  é€»è¾‘ç±»å‹
     * @param ownerId    æ‹¥æœ‰è€…ID
     * @param lockField  é”å­—æ®µ
     * @param expireTime è¿‡æœŸæ—¶é—´(ç§’)
     * @param callBack   å›è°ƒå‡½æ•°
     */
    void asyncLock(String appId, String regionId, String logicType, 
                   String ownerId, String lockField, Integer expireTime, 
                   CallBack<Boolean> callBack);
    
    /**
     * å¼‚æ­¥è§£é”
     * @param appId      åº”ç”¨ID
     * @param regionId   åŒºåŸŸID
     * @param logicType  é€»è¾‘ç±»å‹
     * @param ownerId    æ‹¥æœ‰è€…ID
     * @param lockField  é”å­—æ®µ
     * @param callBack   å›è°ƒå‡½æ•°
     */
    void asyncUnlock(String appId, String regionId, String logicType, 
                     String ownerId, String lockField, CallBack<Boolean> callBack);
    
    /**
     * åŒæ­¥åŠ é”
     * @param appId      åº”ç”¨ID
     * @param regionId   åŒºåŸŸID
     * @param logicType  é€»è¾‘ç±»å‹
     * @param ownerId    æ‹¥æœ‰è€…ID
     * @param lockField  é”å­—æ®µ
     * @param expireTime è¿‡æœŸæ—¶é—´(ç§’)
     * @return æ˜¯å¦åŠ é”æˆåŠŸ
     */
    boolean lock(String appId, String regionId, String logicType, 
                 String ownerId, String lockField, Integer expireTime);
    
    /**
     * åŒæ­¥è§£é”
     * @param appId      åº”ç”¨ID
     * @param regionId   åŒºåŸŸID
     * @param logicType  é€»è¾‘ç±»å‹
     * @param ownerId    æ‹¥æœ‰è€…ID
     * @param lockField  é”å­—æ®µ
     * @return æ˜¯å¦è§£é”æˆåŠŸ
     */
    boolean unlock(String appId, String regionId, String logicType, 
                   String ownerId, String lockField);
}
```

## ä½¿ç”¨ç¤ºä¾‹

### å¼‚æ­¥æ“ä½œç¤ºä¾‹

```java
@Service
public class AsyncLockService {
    
    @Autowired
    private LockDriver lockDriver;
    
    public void asyncProcess(String resourceId) {
        String lockKey = "resource:" + resourceId;
        int expireTime = 60;
        
        // å¼‚æ­¥åŠ é”
        lockDriver.asyncLock("app1", "region1", "resource", resourceId, lockKey, expireTime, 
            new CallBack<Boolean>() {
                @Override
                public void onBack(Boolean success) {
                    if (success) {
                        try {
                            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                            doProcessResource(resourceId);
                        } finally {
                            // å¼‚æ­¥è§£é”
                            lockDriver.asyncUnlock("app1", "region1", "resource", resourceId, lockKey, 
                                new CallBack<Boolean>() {
                                    @Override
                                    public void onBack(Boolean success) {
                                        log.info("é”é‡Šæ”¾ç»“æœ: {}", success);
                                    }
                                });
                        }
                    } else {
                        log.warn("è·å–é”å¤±è´¥: {}", resourceId);
                    }
                }
            });
    }
}
```

### å“åº”å¼ç¼–ç¨‹ç¤ºä¾‹

```java
@Service
public class ReactiveLockService {
    
    @Autowired
    private LockDriver lockDriver;
    
    public Homo<String> processWithLock(String resourceId) {
        String lockKey = "resource:" + resourceId;
        int expireTime = 30;
        
        return Homo.warp(sink -> {
            lockDriver.asyncLock("app1", "region1", "resource", resourceId, lockKey, expireTime, 
                new CallBack<Boolean>() {
                    @Override
                    public void onBack(Boolean success) {
                        if (success) {
                            try {
                                String result = doProcessResource(resourceId);
                                sink.success(result);
                            } catch (Exception e) {
                                sink.error(e);
                            } finally {
                                lockDriver.asyncUnlock("app1", "region1", "resource", resourceId, lockKey, 
                                    result -> log.info("é”é‡Šæ”¾: {}", result));
                            }
                        } else {
                            sink.error(new RuntimeException("è·å–é”å¤±è´¥"));
                        }
                    }
                });
        });
    }
}
```

### é‡è¯•æœºåˆ¶ç¤ºä¾‹

```java
@Service
public class RetryLockService {
    
    @Autowired
    private LockDriver lockDriver;
    
    public boolean processWithRetry(String resourceId, int maxRetries) {
        String lockKey = "resource:" + resourceId;
        int expireTime = 30;
        
        for (int i = 0; i < maxRetries; i++) {
            boolean locked = lockDriver.lock("app1", "region1", "resource", resourceId, lockKey, expireTime);
            
            if (locked) {
                try {
                    doProcessResource(resourceId);
                    return true;
                } finally {
                    lockDriver.unlock("app1", "region1", "resource", resourceId, lockKey);
                }
            } else {
                // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                try {
                    Thread.sleep(100 * (i + 1)); // é€’å¢ç­‰å¾…æ—¶é—´
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
        
        return false;
    }
}
```

## æœ€ä½³å®è·µ

### 1. é”çš„ç²’åº¦è®¾è®¡

```java
// âœ… å¥½çš„åšæ³•ï¼šç»†ç²’åº¦é”
String lockKey = "order:" + orderId; // æŒ‰è®¢å•IDåŠ é”

// âŒ é¿å…ï¼šç²—ç²’åº¦é”
String lockKey = "all_orders"; // å…¨å±€é”ï¼Œå½±å“å¹¶å‘æ€§èƒ½
```

### 2. è¿‡æœŸæ—¶é—´è®¾ç½®

```java
// âœ… æ ¹æ®ä¸šåŠ¡å¤„ç†æ—¶é—´åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´
int expireTime = 30; // 30ç§’ï¼Œé€‚åˆå¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯

// âŒ é¿å…ï¼šè¿‡æœŸæ—¶é—´è¿‡çŸ­æˆ–è¿‡é•¿
int expireTime = 1;  // è¿‡çŸ­ï¼Œå¯èƒ½å¯¼è‡´ä¸šåŠ¡æœªå®Œæˆå°±é‡Šæ”¾é”
int expireTime = 3600; // è¿‡é•¿ï¼Œå¯èƒ½å¯¼è‡´æ­»é”æ—¶é•¿æ—¶é—´æ— æ³•è·å–é”
```

### 3. å¼‚å¸¸å¤„ç†

```java
public void safeProcess(String resourceId) {
    String lockKey = "resource:" + resourceId;
    boolean locked = false;
    
    try {
        locked = lockDriver.lock("app1", "region1", "resource", resourceId, lockKey, 30);
        
        if (locked) {
            doProcessResource(resourceId);
        } else {
            throw new RuntimeException("è·å–é”å¤±è´¥");
        }
    } catch (Exception e) {
        log.error("å¤„ç†èµ„æºå¤±è´¥: {}", resourceId, e);
        throw e;
    } finally {
        if (locked) {
            lockDriver.unlock("app1", "region1", "resource", resourceId, lockKey);
        }
    }
}
```

### 4. é”çš„å‘½åè§„èŒƒ

```java
// âœ… ä½¿ç”¨æœ‰æ„ä¹‰çš„é”åç§°
String lockKey = "user:" + userId + ":profile"; // ç”¨æˆ·èµ„æ–™é”
String lockKey = "order:" + orderId + ":payment"; // è®¢å•æ”¯ä»˜é”
String lockKey = "inventory:" + productId; // åº“å­˜é”

// âŒ é¿å…ï¼šæ— æ„ä¹‰çš„é”åç§°
String lockKey = "lock1";
String lockKey = "temp";
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å‡å°‘é”æŒæœ‰æ—¶é—´

```java
// âœ… å¥½çš„åšæ³•ï¼šæœ€å°åŒ–é”çš„æŒæœ‰æ—¶é—´
public void processOrder(String orderId) {
    String lockKey = "order:" + orderId;
    
    // åœ¨é”å¤–è¿›è¡Œæ•°æ®å‡†å¤‡
    OrderData data = prepareOrderData(orderId);
    
    boolean locked = lockDriver.lock("app1", "region1", "order", orderId, lockKey, 30);
    if (locked) {
        try {
            // åªåœ¨å®é™…éœ€è¦ä¿®æ”¹å…±äº«èµ„æºæ—¶æŒæœ‰é”
            updateOrderStatus(data);
        } finally {
            lockDriver.unlock("app1", "region1", "order", orderId, lockKey);
        }
    }
}
```

### 2. ä½¿ç”¨å¼‚æ­¥æ“ä½œ

```java
// âœ… ä½¿ç”¨å¼‚æ­¥æ“ä½œæé«˜æ€§èƒ½
public void asyncProcess(String resourceId) {
    lockDriver.asyncLock("app1", "region1", "resource", resourceId, "resource:" + resourceId, 30, 
        result -> {
            if (result) {
                // å¼‚æ­¥å¤„ç†ä¸šåŠ¡é€»è¾‘
                processResourceAsync(resourceId);
            }
        });
}
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é”è·å–å¤±è´¥**
   - æ£€æŸ¥ Redis è¿æ¥çŠ¶æ€
   - ç¡®è®¤é”çš„ key æ˜¯å¦è¢«å…¶ä»–è¿›ç¨‹å ç”¨
   - æ£€æŸ¥é”çš„è¿‡æœŸæ—¶é—´è®¾ç½®

2. **é”é‡Šæ”¾å¤±è´¥**
   - ç¡®è®¤é”çš„æ‹¥æœ‰è€…æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥ Redis è¿æ¥çŠ¶æ€
   - æŸ¥çœ‹ Redis æ—¥å¿—

3. **æ€§èƒ½é—®é¢˜**
   - å‡å°‘é”çš„æŒæœ‰æ—¶é—´
   - ä½¿ç”¨æ›´ç»†ç²’åº¦çš„é”
   - è€ƒè™‘ä½¿ç”¨å¼‚æ­¥æ“ä½œ

### ç›‘æ§å»ºè®®

```java
// æ·»åŠ ç›‘æ§æŒ‡æ ‡
@Component
public class LockMonitor {
    
    private final MeterRegistry meterRegistry;
    
    public LockMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }
    
    public void recordLockAttempt(String lockType, boolean success) {
        Counter.builder("lock.attempts")
            .tag("type", lockType)
            .tag("success", String.valueOf(success))
            .register(meterRegistry)
            .increment();
    }
    
    public void recordLockDuration(String lockType, Duration duration) {
        Timer.builder("lock.duration")
            .tag("type", lockType)
            .register(meterRegistry)
            .record(duration);
    }
}
```

## ç›¸å…³é“¾æ¥

- [homo-core æ¡†æ¶æ–‡æ¡£](../README.md)
- [Redis åˆ†å¸ƒå¼é”å®ç°åŸç†](https://redis.io/topics/distlock)
- [åˆ†å¸ƒå¼é”æœ€ä½³å®è·µ](https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html)
