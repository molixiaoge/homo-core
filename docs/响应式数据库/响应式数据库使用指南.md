# å“åº”å¼æ•°æ®åº“ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

homo-core å“åº”å¼æ•°æ®åº“æ¨¡å—åŸºäºå“åº”å¼ç¼–ç¨‹ç†å¿µï¼Œæä¾›äº†é«˜æ•ˆã€éé˜»å¡çš„æ•°æ®åº“æ“ä½œèƒ½åŠ›ã€‚æ”¯æŒ MySQL ç­‰å¤šç§å…³ç³»å‹æ•°æ®åº“ï¼Œç‰¹åˆ«é€‚ç”¨äºé«˜å¹¶å‘ã€ä½å»¶è¿Ÿçš„æ¸¸æˆæœåŠ¡å™¨åœºæ™¯ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âš¡ **å“åº”å¼ç¼–ç¨‹**: åŸºäº Reactor æ¡†æ¶ï¼Œå…¨å¼‚æ­¥éé˜»å¡æ“ä½œ
- ğŸ”„ **è‡ªåŠ¨å»ºè¡¨**: æ ¹æ®æ³¨è§£è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„
- ğŸ“Š **ä¸°å¯ŒæŸ¥è¯¢**: æ”¯æŒå¤æ‚æŸ¥è¯¢ã€èšåˆæ“ä½œã€å…³è”æŸ¥è¯¢
- ğŸ›¡ï¸ **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
- ğŸ¯ **ç®€æ´ API**: æµå¼ API è®¾è®¡ï¼Œä»£ç ç®€æ´æ˜“è¯»
- ğŸ”§ **çµæ´»é…ç½®**: æ”¯æŒè¯»å†™åˆ†ç¦»ã€è¿æ¥æ± é…ç½®ç­‰

## ç¯å¢ƒè¦æ±‚

- **JDK**: 8 æˆ–æ›´é«˜ç‰ˆæœ¬
- **MySQL**: 5.7 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Maven**: 3.6.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Apollo é…ç½®ä¸­å¿ƒ**: ç”¨äºé…ç½®ç®¡ç†

## å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ ä¾èµ–

```xml
<dependencies>
    <!-- å“åº”å¼æ•°æ®åº“åŸºç¡€æ¨¡å— -->
    <dependency>
        <groupId>com.homo</groupId>
        <artifactId>homo-core-relational-base</artifactId>
    </dependency>
    
    <!-- MySQL é©±åŠ¨ -->
    <dependency>
        <groupId>com.homo</groupId>
        <artifactId>homo-core-relational-driver-mysql</artifactId>
    </dependency>
</dependencies>
```

### 2. é…ç½®æ•°æ®åº“

åœ¨ `application.properties` ä¸­é…ç½®ï¼š

```properties
# Apollo é…ç½®
apollo.bootstrap.enabled=true
apollo.bootstrap.namespaces=application,homo_relational_mysql

# MySQL é…ç½®
homo.datasource.url=jdbc:mysql://localhost:3306/game_db
homo.datasource.username=root
homo.datasource.password=password
homo.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# R2DBC é…ç½®
homo.relational.mysql.connect.url=r2dbc:mysql://localhost:3306/game_db?useSSL=false&characterEncoding=UTF-8
homo.relational.mysql.connect.username=root
homo.relational.mysql.connect.password=password
homo.relational.mysql.connect.database=game_db
```

### 3. å®šä¹‰æ•°æ®è¡¨

```java
@HomoTable(value = "user_info", 
           indices = {@HomoIndex(columns = {"user_id"}, indexType = HomoIndex.IndexType.UNIQUE)})
public class UserInfo {
    
    @HomoId(autoGenerate = true)
    public Long id;
    
    @HomoColumn(value = "user_id", length = 64)
    public String userId;
    
    @HomoColumn(value = "nickname", length = 128)
    public String nickname;
    
    @HomoColumn(value = "level", nullable = false)
    public Integer level;
    
    @HomoColumn(value = "exp", nullable = false)
    public Long exp;
    
    @HomoColumn(value = "create_time", nullable = false)
    public Long createTime;
    
    @HomoColumn(value = "update_time", nullable = false)
    public Long updateTime;
}
```

### 4. ä½¿ç”¨ RelationalTemplate

```java
@Service
public class UserService extends BaseService {
    
    @Autowired
    private RelationalTemplate relationalTemplate;
    
    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
    public Homo<UserInfo> saveUser(UserInfo userInfo) {
        return relationalTemplate.save(UserInfo.class)
            .value(userInfo)
            .nextDo(savedUser -> {
                log.info("ä¿å­˜ç”¨æˆ·æˆåŠŸ: {}", savedUser.getUserId());
                return Homo.result(savedUser);
            });
    }
    
    // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    public Homo<UserInfo> getUserById(String userId) {
        HomoCriteria criteria = HomoCriteria.where("user_id").eq(userId);
        return relationalTemplate.find(UserInfo.class)
            .matching(HomoQuery.query(criteria))
            .findOne()
            .nextDo(user -> {
                if (user != null) {
                    log.info("æŸ¥è¯¢åˆ°ç”¨æˆ·: {}", user.getNickname());
                }
                return Homo.result(user);
            });
    }
}
```

## æ ¸å¿ƒæ³¨è§£

### @HomoTable

å®šä¹‰æ•°æ®è¡¨çš„åŸºæœ¬ä¿¡æ¯ï¼š

```java
@HomoTable(
    value = "table_name",           // è¡¨å
    generate = true,                // æ˜¯å¦è‡ªåŠ¨ç”Ÿæˆè¡¨
    indices = {...},               // ç´¢å¼•å®šä¹‰
    nameStrategy = DefaultHomoTableDivideStrategy.class,  // åˆ†è¡¨ç­–ç•¥
    driverName = ""                // é©±åŠ¨åç§°
)
```

### @HomoIndex

å®šä¹‰è¡¨ç´¢å¼•ï¼š

```java
@HomoIndex(
    name = "idx_user_id",          // ç´¢å¼•å
    columns = {"user_id"},         // ç´¢å¼•åˆ—
    indexType = IndexType.UNIQUE   // ç´¢å¼•ç±»å‹
)

public enum IndexType {
    UNIQUE,    // å”¯ä¸€ç´¢å¼•
    NORMAL     // æ™®é€šç´¢å¼•
}
```

### @HomoColumn

å®šä¹‰åˆ—å±æ€§ï¼š

```java
@HomoColumn(
    value = "column_name",         // åˆ—å
    length = 255,                  // é•¿åº¦
    nullable = true,               // æ˜¯å¦å¯ç©º
    defaultValue = "",             // é»˜è®¤å€¼
    precision = 0,                 // ç²¾åº¦
    scale = 0                      // å°æ•°ä½æ•°
)
```

### @HomoId

å®šä¹‰ä¸»é”®ï¼š

```java
@HomoId(autoGenerate = true)  // è‡ªåŠ¨ç”Ÿæˆä¸»é”®
public Long id;
```

## æ•°æ®æ“ä½œ

### æ’å…¥æ“ä½œ

```java
// ä¿å­˜å•ä¸ªå¯¹è±¡ï¼ˆå­˜åœ¨åˆ™æ›´æ–°ï¼‰
public Homo<UserInfo> saveUser(UserInfo user) {
    return relationalTemplate.save(UserInfo.class)
        .value(user);
}

// æ’å…¥å•ä¸ªå¯¹è±¡ï¼ˆå­˜åœ¨åˆ™å¤±è´¥ï¼‰
public Homo<UserInfo> insertUser(UserInfo user) {
    return relationalTemplate.insert(UserInfo.class)
        .value(user);
}

// æ‰¹é‡æ’å…¥
public Homo<List<UserInfo>> insertUsers(List<UserInfo> users) {
    UserInfo[] userArray = users.toArray(new UserInfo[0]);
    return relationalTemplate.insert(UserInfo.class)
        .values(userArray);
}
```

### æŸ¥è¯¢æ“ä½œ

```java
// æŸ¥è¯¢æ‰€æœ‰è®°å½•
public Homo<List<UserInfo>> getAllUsers() {
    return relationalTemplate.find(UserInfo.class)
        .findAll();
}

// æ¡ä»¶æŸ¥è¯¢
public Homo<List<UserInfo>> getUsersByLevel(int minLevel) {
    HomoCriteria criteria = HomoCriteria.where("level").greaterThanOrEqualTo(minLevel);
    return relationalTemplate.find(UserInfo.class)
        .matching(HomoQuery.query(criteria))
        .findAll();
}

// åˆ†é¡µæŸ¥è¯¢
public Homo<List<UserInfo>> getUsersWithPagination(int page, int size) {
    HomoCriteria criteria = HomoCriteria.where("level").greaterThan(0);
    return relationalTemplate.find(UserInfo.class)
        .matching(HomoQuery.query(criteria)
            .sort(HomoSort.by(HomoSort.Order.desc("create_time")))
            .limit(size)
            .offset(page * size))
        .findAll();
}

// ç»Ÿè®¡æŸ¥è¯¢
public Homo<Long> getUserCount() {
    return relationalTemplate.find(UserInfo.class)
        .count();
}

// å­˜åœ¨æ€§æ£€æŸ¥
public Homo<Boolean> userExists(String userId) {
    HomoCriteria criteria = HomoCriteria.where("user_id").eq(userId);
    return relationalTemplate.find(UserInfo.class)
        .matching(HomoQuery.query(criteria))
        .exists();
}
```

### æ›´æ–°æ“ä½œ

```java
// å¯¹è±¡æ›´æ–°
public Homo<UserInfo> updateUser(UserInfo user) {
    HomoCriteria criteria = HomoCriteria.where("id").eq(user.getId());
    return relationalTemplate.update(UserInfo.class)
        .matching(HomoQuery.query(criteria))
        .apply(user);
}

// å­—æ®µæ›´æ–°
public Homo<Long> updateUserLevel(String userId, int newLevel) {
    HomoCriteria criteria = HomoCriteria.where("user_id").eq(userId);
    HomoUpdate update = HomoUpdate.builder()
        .set("level", newLevel)
        .set("update_time", System.currentTimeMillis())
        .build();
    return relationalTemplate.update(UserInfo.class)
        .matching(HomoQuery.query(criteria))
        .apply(update);
}
```

### åˆ é™¤æ“ä½œ

```java
// åˆ é™¤ç”¨æˆ·
public Homo<Long> deleteUser(String userId) {
    HomoCriteria criteria = HomoCriteria.where("user_id").eq(userId);
    return relationalTemplate.delete(UserInfo.class)
        .matching(HomoQuery.query(criteria))
        .all();
}
```

### èšåˆæ“ä½œ

```java
// åˆ†ç»„ç»Ÿè®¡
public Homo<List<UserLevelStats>> getUserLevelStats() {
    HomoAggregation aggregation = HomoAggregation.newBuilder(UserInfo.class)
        .group(GroupOp.create("level")
            .count("user_count")
            .avg("avg_exp", "exp"))
        .sort(SortOp.create("level", SortOp.Order.ASC))
        .build();
    
    return relationalTemplate.aggregate(aggregation, UserLevelStats.class)
        .all();
}

// å…³è”æŸ¥è¯¢
public Homo<List<UserWithOrder>> getUsersWithOrders() {
    HomoAggregation aggregation = HomoAggregation.newBuilder(UserInfo.class)
        .project(ProjectOp.New()
            .andProject("user_id")
            .andProject("nickname")
            .andProject("level"))
        .lookup("order_info", "user_id", "user_id", "orders")
        .match(HomoCriteria.where("level").greaterThan(10))
        .limit(100)
        .build();
    
    return relationalTemplate.aggregate(aggregation, UserWithOrder.class)
        .all();
}
```

### åŸç”Ÿ SQL æ‰§è¡Œ

```java
// æ‰§è¡ŒåŸç”Ÿ SQL
public Homo<List<Map<String, Object>>> executeCustomQuery() {
    String sql = "SELECT user_id, nickname, level FROM user_info WHERE level > ? ORDER BY create_time DESC LIMIT ?";
    return relationalTemplate.execute(sql)
        .all()
        .nextDo(results -> {
            log.info("æŸ¥è¯¢ç»“æœæ•°é‡: {}", results.size());
            return Homo.result(results);
        });
}

// æ›´æ–°æ“ä½œ
public Homo<Integer> executeUpdate() {
    String sql = "UPDATE user_info SET level = level + 1 WHERE user_id = ?";
    return relationalTemplate.execute(sql)
        .rowsUpdated();
}
```

## æŸ¥è¯¢æ¡ä»¶æ„å»º

### HomoCriteria ä½¿ç”¨

```java
// åŸºæœ¬æ¡ä»¶
HomoCriteria.where("name").eq("å¼ ä¸‰")
HomoCriteria.where("age").greaterThan(18)
HomoCriteria.where("age").lessThanOrEqualTo(65)
HomoCriteria.where("name").like("%å¼ %")
HomoCriteria.where("status").in("active", "pending")

// ç»„åˆæ¡ä»¶
HomoCriteria.where("age").between(18, 65)
    .and("status").eq("active")
    .or("level").greaterThan(10)

// ç©ºå€¼æ£€æŸ¥
HomoCriteria.where("email").isNull()
HomoCriteria.where("phone").isNotNull()
```

### æ’åºå’Œåˆ†é¡µ

```java
// æ’åº
HomoSort.by(HomoSort.Order.asc("create_time"))
HomoSort.by(HomoSort.Order.desc("level"), HomoSort.Order.asc("exp"))

// åˆ†é¡µ
HomoQuery.query(criteria)
    .sort(sort)
    .limit(20)
    .offset(40)  // ç¬¬3é¡µï¼Œæ¯é¡µ20æ¡
```

## é…ç½®è¯¦è§£

### æ•°æ®æºé…ç½®

```java
@Configuration
public class DatabaseConfig {
    
    @Bean
    @Primary
    public DataSource masterDataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl("jdbc:mysql://localhost:3306/game_db");
        dataSource.setUsername("root");
        dataSource.setPassword("password");
        dataSource.setMaximumPoolSize(20);
        dataSource.setMinimumIdle(5);
        return dataSource;
    }
    
    @Bean
    public DataSource slaveDataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl("jdbc:mysql://slave:3306/game_db");
        dataSource.setUsername("root");
        dataSource.setPassword("password");
        return dataSource;
    }
    
    @Bean
    public DynamicDataSource dynamicDataSource() {
        Map<Object, Object> dataSourceMap = new HashMap<>();
        dataSourceMap.put("master", masterDataSource());
        dataSourceMap.put("slave", slaveDataSource());
        return new DynamicDataSource(dataSourceMap);
    }
}
```

### è¯»å†™åˆ†ç¦»é…ç½®

```properties
# ä¸»åº“é…ç½®
homo.datasource.master.url=jdbc:mysql://master:3306/game_db
homo.datasource.master.username=root
homo.datasource.master.password=password

# ä»åº“é…ç½®
homo.datasource.slave.url=jdbc:mysql://slave:3306/game_db
homo.datasource.slave.username=root
homo.datasource.slave.password=password

# è¿æ¥æ± é…ç½®
homo.datasource.maxActive=20
homo.datasource.minIdle=5
homo.datasource.maxWait=60000
```

## æœ€ä½³å®è·µ

### 1. è¡¨è®¾è®¡è§„èŒƒ

```java
// âœ… å¥½çš„åšæ³•ï¼šåˆç†ä½¿ç”¨ç´¢å¼•
@HomoTable(value = "user_info",
    indices = {
        @HomoIndex(columns = {"user_id"}, indexType = IndexType.UNIQUE),
        @HomoIndex(columns = {"level", "exp"}, indexType = IndexType.NORMAL)
    })
public class UserInfo {
    // ...
}

// âŒ é¿å…ï¼šè¿‡å¤šæˆ–è¿‡å°‘çš„ç´¢å¼•
@HomoTable(value = "user_info",
    indices = {
        @HomoIndex(columns = {"user_id"}),
        @HomoIndex(columns = {"nickname"}),
        @HomoIndex(columns = {"level"}),
        @HomoIndex(columns = {"exp"}),
        @HomoIndex(columns = {"create_time"})
    })
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```java
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨åˆé€‚çš„æŸ¥è¯¢æ¡ä»¶
public Homo<List<UserInfo>> getActiveUsers(int minLevel) {
    HomoCriteria criteria = HomoCriteria.where("status").eq("active")
        .and("level").greaterThanOrEqualTo(minLevel);
    return relationalTemplate.find(UserInfo.class)
        .matching(HomoQuery.query(criteria)
            .sort(HomoSort.by(HomoSort.Order.desc("last_login_time")))
            .limit(100))
        .findAll();
}

// âŒ é¿å…ï¼šå…¨è¡¨æ‰«æ
public Homo<List<UserInfo>> getAllUsers() {
    return relationalTemplate.find(UserInfo.class)
        .findAll(); // å¯èƒ½è¿”å›å¤§é‡æ•°æ®
}
```

### 3. äº‹åŠ¡å¤„ç†

```java
@Service
@Transactional
public class UserService {
    
    public Homo<Void> transferExp(String fromUserId, String toUserId, long exp) {
        return getUserById(fromUserId)
            .nextDo(fromUser -> {
                if (fromUser.getExp() < exp) {
                    return Homo.error(new RuntimeException("ç»éªŒä¸è¶³"));
                }
                return updateUserExp(fromUserId, -exp)
                    .nextDo(result -> updateUserExp(toUserId, exp));
            });
    }
}
```

### 4. é”™è¯¯å¤„ç†

```java
public Homo<UserInfo> getUserSafely(String userId) {
    return relationalTemplate.find(UserInfo.class)
        .matching(HomoQuery.query(HomoCriteria.where("user_id").eq(userId)))
        .findOne()
        .onErrorContinue(throwable -> {
            log.error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: {}", userId, throwable);
            return Homo.result(null);
        });
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. è¿æ¥æ± ä¼˜åŒ–

```properties
# æ ¹æ®å¹¶å‘é‡è°ƒæ•´è¿æ¥æ± å¤§å°
homo.datasource.maxActive=50
homo.datasource.minIdle=10
homo.datasource.maxWait=30000

# è¿æ¥éªŒè¯
homo.datasource.testOnBorrow=true
homo.datasource.validationQuery=SELECT 1
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```java
// ä½¿ç”¨æŠ•å½±å‡å°‘æ•°æ®ä¼ è¾“
public Homo<List<UserBasicInfo>> getUserBasicInfo() {
    HomoAggregation aggregation = HomoAggregation.newBuilder(UserInfo.class)
        .project(ProjectOp.New()
            .andProject("user_id")
            .andProject("nickname")
            .andProject("level"))
        .build();
    
    return relationalTemplate.aggregate(aggregation, UserBasicInfo.class)
        .all();
}
```

### 3. æ‰¹é‡æ“ä½œ

```java
// æ‰¹é‡æ’å…¥
public Homo<List<UserInfo>> batchInsertUsers(List<UserInfo> users) {
    UserInfo[] userArray = users.toArray(new UserInfo[0]);
    return relationalTemplate.insert(UserInfo.class)
        .values(userArray);
}
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¡¨åˆ›å»ºå¤±è´¥**
   - æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®
   - ç¡®è®¤ç”¨æˆ·æƒé™
   - æŸ¥çœ‹å»ºè¡¨ SQL æ—¥å¿—

2. **æŸ¥è¯¢è¶…æ—¶**
   - æ£€æŸ¥æŸ¥è¯¢æ¡ä»¶æ˜¯å¦åˆç†
   - ç¡®è®¤ç´¢å¼•æ˜¯å¦æ­£ç¡®åˆ›å»º
   - è°ƒæ•´è¿æ¥æ± é…ç½®

3. **äº‹åŠ¡å›æ»š**
   - æ£€æŸ¥æ•°æ®å®Œæ•´æ€§çº¦æŸ
   - ç¡®è®¤å¤–é”®å…³ç³»
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—

### è°ƒè¯•æŠ€å·§

```java
// å¯ç”¨ SQL æ—¥å¿—
logging.level.org.springframework.r2dbc=DEBUG
logging.level.io.r2dbc.mysql=DEBUG

// æ€§èƒ½ç›‘æ§
@Component
public class DatabaseMetrics {
    
    @EventListener
    public void handleQueryEvent(QueryEvent event) {
        // è®°å½•æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡
        Timer.builder("database.query.duration")
            .tag("table", event.getTableName())
            .tag("operation", event.getOperation())
            .register(meterRegistry)
            .record(event.getDuration());
    }
}
```

## ç›¸å…³é“¾æ¥

- [homo-core æ¡†æ¶æ–‡æ¡£](../README.md)
- [R2DBC å®˜æ–¹æ–‡æ¡£](https://r2dbc.io/)
- [MySQL å®˜æ–¹æ–‡æ¡£](https://dev.mysql.com/doc/)
- [å“åº”å¼ç¼–ç¨‹æŒ‡å—](https://projectreactor.io/docs/core/release/reference/)
