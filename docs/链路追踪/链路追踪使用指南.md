# é“¾è·¯è¿½è¸ªä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

homo-core é“¾è·¯è¿½è¸ªæ¨¡å—åŸºäº Zipkin å®ç°äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„å…¨é“¾è·¯è¿½è¸ªåŠŸèƒ½ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆå’Œæ’æŸ¥é—®é¢˜ã€‚æ¡†æ¶æ‰€æœ‰æ¨¡å—éƒ½å·²é›†æˆé“¾è·¯è¿½è¸ªåŠŸèƒ½ï¼Œåªéœ€ç®€å•é…ç½®å³å¯ä½¿ç”¨ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ” **å…¨é“¾è·¯è¿½è¸ª**: è‡ªåŠ¨è¿½è¸ªè¯·æ±‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å®Œæ•´è°ƒç”¨é“¾
- ğŸ“Š **æ€§èƒ½ç›‘æ§**: å®æ—¶ç›‘æ§å„æœåŠ¡çš„å“åº”æ—¶é—´å’Œååé‡
- ğŸ› **é—®é¢˜æ’æŸ¥**: å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆå’Œé”™è¯¯æ ¹æº
- ğŸ“ˆ **å¯è§†åŒ–ç•Œé¢**: åŸºäº Zipkin UI çš„ç›´è§‚å±•ç¤º
- âš¡ **ä½æ€§èƒ½å¼€é”€**: æœ€å°åŒ–å¯¹ä¸šåŠ¡æ€§èƒ½çš„å½±å“
- ğŸ”§ **çµæ´»é…ç½®**: æ”¯æŒé‡‡æ ·ç‡ã€ä¸ŠæŠ¥åœ°å€ç­‰é…ç½®

## ç¯å¢ƒè¦æ±‚

- **JDK**: 8 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Zipkin Server**: 2.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **homo-core**: 1.0 æˆ–æ›´é«˜ç‰ˆæœ¬

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ Zipkin æœåŠ¡

#### ä½¿ç”¨ Docker å¯åŠ¨

```bash
# å¯åŠ¨ Zipkin æœåŠ¡
docker run -d -p 9411:9411 openzipkin/zipkin

# æˆ–è€…ä½¿ç”¨ MySQL å­˜å‚¨
docker run -d -p 9411:9411 \
  -e STORAGE_TYPE=mysql \
  -e MYSQL_HOST=localhost \
  -e MYSQL_USER=zipkin \
  -e MYSQL_PASS=zipkin \
  -e MYSQL_DB=zipkin \
  openzipkin/zipkin
```

#### ä½¿ç”¨ Docker Compose

```yaml
version: '3.8'
services:
  zipkin:
    image: openzipkin/zipkin
    ports:
      - "9411:9411"
    environment:
      - STORAGE_TYPE=mysql
      - MYSQL_HOST=mysql
      - MYSQL_USER=zipkin
      - MYSQL_PASS=zipkin
      - MYSQL_DB=zipkin
  
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=zipkin
      - MYSQL_USER=zipkin
      - MYSQL_PASSWORD=zipkin
    ports:
      - "3306:3306"
```

### 2. é…ç½®åº”ç”¨

åœ¨ `application.properties` ä¸­æ·»åŠ é…ç½®ï¼š

```properties
# å¯ç”¨é“¾è·¯è¿½è¸ª
homo.zipkin.client.trace.open=true

# Zipkin æœåŠ¡åœ°å€
homo.zipkin.server.addr=127.0.0.1
homo.zipkin.server.port=9411

# é‡‡æ ·é…ç½®
homo.zipkin.client.trace.perSecond=10

# æ”¯æŒè·¨æœåŠ¡è¿½è¸ª
homo.zipkin.server.supportsJoin=true
```

### 3. è‡ªåŠ¨é›†æˆ

æ¡†æ¶ä¼šè‡ªåŠ¨ä¸ºä»¥ä¸‹æ“ä½œæ·»åŠ é“¾è·¯è¿½è¸ªï¼š

- RPC è°ƒç”¨ (HTTP/gRPC)
- æ•°æ®åº“æ“ä½œ (MySQL/MongoDB)
- ç¼“å­˜æ“ä½œ (Redis)
- æ¶ˆæ¯é˜Ÿåˆ—æ“ä½œ (Kafka)
- å­˜å‚¨æ“ä½œ

## é…ç½®è¯¦è§£

### ZipkinProperties é…ç½®ç±»

```java
@Configurable
@Data
public class ZipKinProperties {
    
    /**
     * Zipkin é…ç½®å‘½åç©ºé—´
     */
    @Value("${homo.zipkin.namespace:homo_zipkin_config}")
    public String zipkinNamespace;
    
    /**
     * é“¾è·¯è¿½è¸ªä¸ŠæŠ¥åœ°å€
     */
    @Value("${homo.zipkin.server.addr:127.0.0.1}")
    public String reportAddr;
    
    /**
     * ä¸ŠæŠ¥ç«¯å£
     */
    @Value("${homo.zipkin.server.port:9411}")
    public String reportPort;
    
    /**
     * æ”¯æŒè·¨æœåŠ¡è¿½è¸ª
     */
    @Value("${homo.zipkin.server.supportsJoin:true}")
    public boolean supportsJoin;
    
    /**
     * æ¯ç§’é‡‡æ ·æ•°
     */
    @Value("${homo.zipkin.client.trace.perSecond:10}")
    public int tracesPerSecond;
    
    /**
     * é“¾è·¯è¿½è¸ªå¼€å…³
     */
    @Value("${homo.zipkin.client.trace.open:false}")
    public boolean isOpen = false;
}
```

### å®Œæ•´é…ç½®ç¤ºä¾‹

```properties
# åŸºç¡€é…ç½®
homo.zipkin.client.trace.open=true
homo.zipkin.server.addr=zipkin-server
homo.zipkin.server.port=9411
homo.zipkin.server.supportsJoin=true

# é‡‡æ ·é…ç½®
homo.zipkin.client.trace.perSecond=100

# å‘½åç©ºé—´é…ç½®
homo.zipkin.namespace=homo_zipkin_config

# æœåŠ¡ä¿¡æ¯
server.info.appId=game-server
server.info.regionId=region-1
server.info.serverName=user-service
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. è‡ªåŠ¨è¿½è¸ªç¤ºä¾‹

```java
@Service
public class UserService extends BaseService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private CacheService cacheService;
    
    // è¿™ä¸ªæ–¹æ³•ä¼šè‡ªåŠ¨è¢«è¿½è¸ª
    public Homo<UserInfo> getUserInfo(String userId) {
        return cacheService.get("user:" + userId, UserInfo.class)
            .nextDo(cachedUser -> {
                if (cachedUser != null) {
                    return Homo.result(cachedUser);
                }
                return userRepository.findById(userId)
                    .nextDo(user -> {
                        // ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
                        return cacheService.set("user:" + userId, user, 3600)
                            .nextDo(result -> Homo.result(user));
                    });
            });
    }
}
```

### 2. æ‰‹åŠ¨åˆ›å»º Span

```java
@Service
public class OrderService {
    
    @Autowired
    private ZipkinUtil zipkinUtil;
    
    public Homo<Order> createOrder(OrderRequest request) {
        // åˆ›å»ºè‡ªå®šä¹‰ Span
        Span span = zipkinUtil.getTracing().tracer()
            .nextSpan()
            .name("create-order")
            .tag("order.type", request.getType())
            .tag("user.id", request.getUserId())
            .start();
        
        try (Tracer.SpanInScope ws = zipkinUtil.getTracing().tracer()
                .withSpanInScope(span)) {
            
            return processOrder(request)
                .nextDo(order -> {
                    span.tag("order.id", order.getId());
                    span.tag("order.amount", String.valueOf(order.getAmount()));
                    return Homo.result(order);
                })
                .onErrorContinue(throwable -> {
                    span.tag("error", throwable.getMessage());
                    span.error(throwable);
                    return Homo.error(throwable);
                });
        } finally {
            span.end();
        }
    }
}
```

### 3. å¼‚æ­¥æ“ä½œè¿½è¸ª

```java
@Service
public class AsyncService {
    
    @Autowired
    private ZipkinUtil zipkinUtil;
    
    public Homo<String> asyncProcess(String data) {
        return Homo.warp(sink -> {
            // åœ¨å¼‚æ­¥æ“ä½œä¸­ä¿æŒè¿½è¸ªä¸Šä¸‹æ–‡
            Span span = zipkinUtil.currentSpan();
            
            CompletableFuture.supplyAsync(() -> {
                try (Tracer.SpanInScope ws = zipkinUtil.getTracing().tracer()
                        .withSpanInScope(span)) {
                    return processData(data);
                }
            }).whenComplete((result, throwable) -> {
                if (throwable != null) {
                    sink.error(throwable);
                } else {
                    sink.success(result);
                }
            });
        });
    }
}
```

## ç›‘æ§å’Œè°ƒè¯•

### 1. Zipkin UI ä½¿ç”¨

è®¿é—® `http://localhost:9411` æ‰“å¼€ Zipkin UIï¼š

1. **æŸ¥çœ‹è¿½è¸ªåˆ—è¡¨**: åœ¨é¦–é¡µæŸ¥çœ‹æœ€è¿‘çš„è¿½è¸ªè®°å½•
2. **æœç´¢è¿½è¸ª**: æ ¹æ®æœåŠ¡åã€æ“ä½œåã€æ ‡ç­¾ç­‰æœç´¢
3. **æŸ¥çœ‹è¯¦æƒ…**: ç‚¹å‡»è¿½è¸ªè®°å½•æŸ¥çœ‹å®Œæ•´çš„è°ƒç”¨é“¾
4. **åˆ†ææ€§èƒ½**: æŸ¥çœ‹å„æ­¥éª¤çš„è€—æ—¶å’Œä¾èµ–å…³ç³»

### 2. å¸¸ç”¨æŸ¥è¯¢æ¡ä»¶

```sql
-- æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„è¿½è¸ª
serviceName=user-service

-- æŸ¥çœ‹ç‰¹å®šæ“ä½œçš„è¿½è¸ª
operationName=getUserInfo

-- æŸ¥çœ‹åŒ…å«ç‰¹å®šæ ‡ç­¾çš„è¿½è¸ª
tag=user.id=12345

-- æŸ¥çœ‹é”™è¯¯è¿½è¸ª
error=true

-- æŸ¥çœ‹è€—æ—¶è¶…è¿‡é˜ˆå€¼çš„è¿½è¸ª
duration=100ms
```

### 3. æ€§èƒ½ç›‘æ§

```java
@Component
public class TraceMetrics {
    
    private final MeterRegistry meterRegistry;
    
    public TraceMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }
    
    @EventListener
    public void handleTraceEvent(TraceEvent event) {
        Timer.Sample sample = Timer.start(meterRegistry);
        
        // è®°å½•è¿½è¸ªæŒ‡æ ‡
        Timer.builder("trace.duration")
            .tag("service", event.getServiceName())
            .tag("operation", event.getOperationName())
            .tag("success", String.valueOf(event.isSuccess()))
            .register(meterRegistry)
            .record(sample);
    }
}
```

## æœ€ä½³å®è·µ

### 1. é‡‡æ ·ç‡é…ç½®

```properties
# å¼€å‘ç¯å¢ƒï¼šé«˜é‡‡æ ·ç‡ï¼Œä¾¿äºè°ƒè¯•
homo.zipkin.client.trace.perSecond=1000

# æµ‹è¯•ç¯å¢ƒï¼šä¸­ç­‰é‡‡æ ·ç‡
homo.zipkin.client.trace.perSecond=100

# ç”Ÿäº§ç¯å¢ƒï¼šä½é‡‡æ ·ç‡ï¼Œå‡å°‘æ€§èƒ½å½±å“
homo.zipkin.client.trace.perSecond=10
```

### 2. æ ‡ç­¾ä½¿ç”¨è§„èŒƒ

```java
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„æ ‡ç­¾
span.tag("user.id", userId);
span.tag("order.type", "premium");
span.tag("payment.method", "credit_card");

// âŒ é¿å…ï¼šä½¿ç”¨æ— æ„ä¹‰çš„æ ‡ç­¾
span.tag("data", "some_data");
span.tag("temp", "value");
```

### 3. é”™è¯¯å¤„ç†

```java
public Homo<String> processWithErrorHandling(String data) {
    return processData(data)
        .onErrorContinue(throwable -> {
            // è®°å½•é”™è¯¯ä¿¡æ¯åˆ°è¿½è¸ª
            Span span = zipkinUtil.currentSpan();
            if (span != null) {
                span.tag("error", throwable.getMessage());
                span.tag("error.type", throwable.getClass().getSimpleName());
                span.error(throwable);
            }
            return Homo.error(throwable);
        });
}
```

### 4. æ€§èƒ½ä¼˜åŒ–

```java
// ä½¿ç”¨æ¡ä»¶é‡‡æ ·
@Component
public class ConditionalSampling {
    
    public boolean shouldSample(String operationName) {
        // åªå¯¹é‡è¦æ“ä½œè¿›è¡Œé‡‡æ ·
        return operationName.startsWith("critical") || 
               operationName.contains("payment");
    }
}
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿½è¸ªæ•°æ®æœªä¸ŠæŠ¥**
   - æ£€æŸ¥ Zipkin æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
   - ç¡®è®¤ç½‘ç»œè¿æ¥å’Œç«¯å£é…ç½®
   - æŸ¥çœ‹åº”ç”¨æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

2. **æ€§èƒ½å½±å“è¿‡å¤§**
   - é™ä½é‡‡æ ·ç‡
   - æ£€æŸ¥æ˜¯å¦æœ‰ä¸å¿…è¦çš„è¿½è¸ªæ“ä½œ
   - ä¼˜åŒ–æ ‡ç­¾æ•°é‡å’Œå¤§å°

3. **è¿½è¸ªæ•°æ®ä¸å®Œæ•´**
   - æ£€æŸ¥ `supportsJoin` é…ç½®
   - ç¡®è®¤æœåŠ¡é—´ä¼ é€’äº†è¿½è¸ªä¸Šä¸‹æ–‡
   - æŸ¥çœ‹å¼‚æ­¥æ“ä½œæ˜¯å¦æ­£ç¡®å¤„ç†äº†ä¸Šä¸‹æ–‡

### è°ƒè¯•æŠ€å·§

```java
// å¯ç”¨è¯¦ç»†æ—¥å¿—
logging.level.zipkin2=DEBUG
logging.level.brave=DEBUG

// æ£€æŸ¥è¿½è¸ªçŠ¶æ€
@RestController
public class TraceController {
    
    @GetMapping("/trace/status")
    public Map<String, Object> getTraceStatus() {
        Map<String, Object> status = new HashMap<>();
        status.put("tracingEnabled", zipkinUtil.getTracing() != null);
        status.put("currentSpan", zipkinUtil.currentSpan() != null);
        return status;
    }
}
```

## ç›¸å…³é“¾æ¥

- [homo-core æ¡†æ¶æ–‡æ¡£](../README.md)
- [Zipkin å®˜æ–¹æ–‡æ¡£](https://zipkin.io/)
- [Brave è¿½è¸ªåº“æ–‡æ¡£](https://github.com/openzipkin/brave)
- [åˆ†å¸ƒå¼è¿½è¸ªæœ€ä½³å®è·µ](https://opentracing.io/docs/best-practices/)
